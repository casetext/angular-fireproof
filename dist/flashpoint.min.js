/*! flashpoint 2.1.0, Â© 2015 J2H2 Inc. MIT License.
 * https://github.com/casetext/flashpoint
 */
!function(t,e){"function"==typeof define&&define.amd?define(["angular","firebase","fireproof"],e):"object"==typeof exports?e(require("angular"),require("firebase"),require("fireproof")):e(t.angular,t.Firebase,t.Fireproof)}(this,function(t,e,r){"use strict";function n(t,e,r,n){var o,i=n.onAttach(function(){o=t.$watch("fp.connected",function(e){e===!0&&t.$eval(r.onConnect)})}),s=n.onDetach(function(){o&&(o(),o=null)});t.$on("$destroy",function(){n.offAttach(i),n.offDetach(s)})}function o(e,r,n,o,i,s,a){function c(t){d.listenerSet&&d.listenerSet.clear(),d.auth=t,e.$evalAsync()}function u(t){d.connected=t.val(),e.$evalAsync()}function h(t){return d.authenticating=!1,d.authError=null,t}function l(t){return d.authenticating=!0,d.authError=t,r.reject(t)}function p(){d.accountChanging=!1,d.accountError=null}function f(t){return d.accountChanging=!1,d.accountError=t,r.reject(t)}var d=this,y=[],m=[];d.auth=null,d.authError=null,d.accountError=null,d.authenticating=!1,d.accountChanging=!1,d.detachFirebase=function(){d.listenerSet&&(d.listenerSet.clear(),delete d.listenerSet),d.root.offAuth(c),d.root.child(".info/connected").off("value",u),delete d.connected,d.root.off(),d.auth=null,d.authError=null,d.accountError=null,d.authenticating=!1,d.accountChanging=!1,m.forEach(function(t){t(d.root)}),delete d.root,e.$evalAsync()},d.onDetach=function(t){return m.push(t),d.root||t(),t},d.offDetach=function(t){m.splice(m.indexOf(t),1)},d.attachFirebase=function(t){d.root&&d.detachFirebase(),d.root=new o(new n(t)),d.listenerSet=new a(d.root,e),d.root.onAuth(c),d.connected=!0,d.root.child(".info/connected").on("value",u),y.forEach(function(t){t(d.root)})},d.onAttach=function(t){return y.push(t),d.root&&t(d.root),t},d.offAttach=function(t){y.splice(y.indexOf(t),1)},d.goOffline=function(){n.goOffline()},d.goOnline=function(){n.goOnline()},d.unauth=function(){d.authError=null,d.accountError=null,d.root.unauth()},d.authWithCustomToken=function(t){return d.authenticating=!0,d.root.authWithCustomToken(t).then(h,l)},d.authAnonymously=function(t){return d.authenticating=!0,d.root.authAnonymously(null,t).then(h,l)},d.authWithPassword=function(t,e){return d.authenticating=!0,d.root.authWithPassword({email:t,password:e}).then(h,l)},d.authWithOAuthPopup=function(t,e){return d.authenticating=!0,d.root.authWithOAuthPopup(t,null,e).then(h,l)},d.authWithOAuthToken=function(t,e,r){return d.authenticating=!0,d.root.authWithOAuthToken(t,e,null,r).then(h,l)},d.createUser=function(t,e){return d.accountChanging=!0,d.root.createUser({email:t,password:e}).then(p,f)},d.removeUser=function(t,e){return d.accountChanging=!0,d.root.removeUser({email:t,password:e}).then(p,f)},d.changeEmail=function(t,e,r){return d.accountChanging=!0,d.root.changeEmail({oldEmail:t,newEmail:e,password:r}).then(p,f)},d.changePassword=function(t,e,r){return d.accountChanging=!0,d.root.changePassword({email:t,oldPassword:e,newPassword:r}).then(p,f)},d.resetPassword=function(t){return d.accountChanging=!0,d.root.resetPassword({email:t}).then(p,f)},d.set=function(){var t=Array.prototype.slice.call(arguments,0),e=t.pop(),r=s(t);return d.root.child(r).set(e)},d.setPriority=function(){var t=Array.prototype.slice.call(arguments,0),e=t.pop(),r=s(t);return d.root.child(r).setPriority(e)},d.setWithPriority=function(){var t=Array.prototype.slice.call(arguments,0),e=t.pop(),r=t.pop(),n=s(t);return d.root.child(n).setWithPriority(r,e)},d.push=function(){var t=Array.prototype.slice.call(arguments,0),e=t.pop(),r=s(t);return d.root.child(r).push(e)},d.update=function(){var t=Array.prototype.slice.call(arguments,0),e=t.pop(),r=s(t);return d.root.child(r).update(e)},d.remove=function(){var t=Array.prototype.slice.call(arguments,0),e=s(t);return d.root.child(e).remove()},d.increment=function(){var e=Array.prototype.slice.call(arguments,0),n=s(e);return d.root.child(n).transaction(function(e){return t.isNumber(e)?e+1:null===e?1:void 0}).then(function(t){return t.committed?void 0:r.reject(new Error("Cannot increment the object at "+n))})},d.decrement=function(){var e=Array.prototype.slice.call(arguments,0),n=s(e);return d.root.child(n).transaction(function(e){return t.isNumber(e)?e-1:null===e?0:void 0}).then(function(t){return t.committed?void 0:r.reject(new Error("Cannot decrement the object at "+n))})},d.transaction=function(){var t=Array.prototype.slice.call(arguments,0),e=t.pop(),n=s(t);return d.root.child(n).transaction(function(t){return e(t)}).then(function(t){return t.committed?void 0:r.reject(new Error("Aborted"))})},d.val=function(){var t=s(Array.prototype.slice.call(arguments,0));if(t)return d.listenerSet.add(t),d.listenerSet.values.hasOwnProperty(t)?d.listenerSet.values[t]:null},d.priority=function(){var t=s(Array.prototype.slice.call(arguments,0));if(t)return d.listenerSet.add(t),d.listenerSet.priorities.hasOwnProperty(t)?d.listenerSet.priorities[t]:null},d.error=function(){var t=s(Array.prototype.slice.call(arguments,0));return t&&d.listenerSet.errors.hasOwnProperty(t)?d.listenerSet.errors[t]:null},d.children=function(){return new i(d.listenerSet)},e.$on("$destroy",function(){d.detachFirebase()})}t.module("flashpoint",[]),t.module("flashpoint").directive("firebase",["$animate",function(t){function e(e,o,i,s){var a=function(t){r&&t===n||(s.attachFirebase(t),r=!0,n=t)};i.firebase&&a(i.firebase),i.$observe("firebase",a),e.$watch("fp.connected",function(e){e===!0?t.setClass(o,"fp-connected","fp-disconnected"):e===!1?t.setClass(o,"fp-disconnected","fp-connected"):t.setClass(o,[],["fp-connected","fp-disconnected"])}),e.$watch("fp.auth",function(e){void 0===e?t.setClass(o,[],["fp-unauthenticated","fp-authenticated"]):null===e?t.setClass(o,"fp-unauthenticated","fp-authenticated"):t.setClass(o,"fp-authenticated","fp-unauthenticated")}),e.$watch("fp.authError",function(e){e?t.addClass(o,"fp-auth-error"):t.removeClass(o,"fp-auth-error")}),e.$watch("fp.accountError",function(e){e?t.addClass(o,"fp-account-error"):t.removeClass(o,"fp-account-error")})}var r,n;return{restrict:"A",scope:!0,controller:"FirebaseCtl",controllerAs:"fp",priority:1e3,link:{pre:e}}}]),t.module("flashpoint").directive("fpFeed",["$q","Feed",function(t,e){function r(t,r,n,o){var i=o.onAttach(function(r){t.$feed=new e(t.$eval(n.fpFeed),function(e,r){if(n.feedQuery)return t.$eval(n.feedQuery,{$ref:e,$start:r});throw new Error("fp-feed requires feed-query to be set")}),t.$feed.setTransform(function(e,r){return n.feedTransform?t.$eval(n.feedTransform,{$object:e,$root:r}):e}),t.$feed.setFilter(function(e,r,o,i){return n.feedFilter?t.$eval(n.feedFilter,{$object:e,$index:r,$newItems:o,$items:i}):function(){return!0}}),t.$feed.setSort(function(e,r){return n.feedSort?t.$eval(n.feedSort,{$a:e,$b:r,$left:e,$right:r}):e.ref().toString().localeCompare(r.ref().toString())}),t.$feed.connect(r)}),s=o.onDetach(function(){t.$feed.disconnect()});t.$on("$destroy",function(){o.offAttach(i),o.offDetach(s),t.$feed.disconnect()})}return{require:"^firebase",scope:!0,link:r}}]),t.module("flashpoint").constant("FP_DEFAULT_PAGE_SIZE",3).directive("fpPage",["FP_DEFAULT_PAGE_SIZE","Page",function(e,r){function n(n,o,i,s){function a(t,r){return r=parseInt(r),isNaN(r)&&(r=e),function(e,n){var o=e.child(t).orderByPriority();return n?o.startAt(n.getPriority(),n.key()).limitToFirst(r+1):o.limitToFirst(r)}}function c(t,r){return r=parseInt(r),isNaN(r)&&(r=e),function(e,n){var o=e.child(t).orderByKey();return n?o.startAt(n.key()).limitToFirst(r+1):o.limitToFirst(r)}}function u(t,r){return r=parseInt(r),isNaN(r)&&(r=e),function(e,n){var o=e.child(t).orderByValue();return n?o.startAt(n.val(),n.key()).limitToFirst(r+1):o.limitToFirst(r)}}function h(r,n,o){return o=parseInt(o),isNaN(o)&&(o=e),function(e,i){var s=e.child(r).orderByChild(n);if(i){var a=i.val();return a=t.isObject(a)?a[n]:null,s.startAt(a,i.key()).limitToFirst(o+1)}return s.limitToFirst(o)}}var l={$orderByPriority:a,$orderByKey:c,$orderByChild:h,$orderByValue:u},p=s.onAttach(function(t){n.$page=new r(n.$eval(i.fpPage,l)),n.$page.connect(t)}),f=s.onDetach(function(){n.$page.disconnect()});n.$on("$destroy",function(){s.offAttach(p),s.offDetach(f),n.$page.disconnect()})}return{link:n,restrict:"A",priority:750,scope:!0,require:"^firebase"}}]),t.module("flashpoint").directive("onAuth",function(){function t(t,e,r,n){function o(e){r.onAuth&&t.$eval(r.onAuth,{$auth:e})}n.onAttach(function(t){t.onAuth(o)}),n.onDetach(function(t){t.offAuth(o)})}return{priority:750,require:"^firebase",restrict:"A",link:{pre:t}}}),t.module("flashpoint").directive("onConnect",function(){return{require:"firebase",link:n}}),t.module("flashpoint").directive("onDisconnect",["$q","$log","validatePath",function(t,e,r){function n(n,o,i,s){var a={},c=function(t){e.debug('onDisconnect: error evaluating "'+i.onDisconnect+'": '+t.code),i.onDisconnectError&&n.$eval(i.onDisconnectError,{$error:t})},u=function(e){return{$set:function(){var n=Array.prototype.slice.call(arguments,0),o=n.pop(),i=r(n);return i?(a[i]=!0,e.child(i).onDisconnect().set(o)["catch"](c)):t.reject(new Error("Invalid path"))},$update:function(){var n=Array.prototype.slice.call(arguments,0),o=n.pop(),i=r(n);return i?(a[i]=!0,e.child(i).onDisconnect().update(o)["catch"](c)):t.reject(new Error("Invalid path"))},$setWithPriority:function(){var n=Array.prototype.slice.call(arguments,0),o=n.pop(),i=n.pop(),s=r(n);return s?(a[s]=!0,e.child(s).onDisconnect().setWithPriority(i,o)["catch"](c)):t.reject(new Error("Invalid path"))},$remove:function(){var n=Array.prototype.slice.call(arguments,0),o=r(n);return o?(a[o]=!0,e.child(o).onDisconnect().remove()["catch"](c)):t.reject(new Error("Invalid path"))}}},h={$set:s.set.bind(s),$remove:s.remove.bind(s),$setWithPriority:s.setWithPriority.bind(s),$update:s.update.bind(s)},l=s.onAttach(function(t){n.$eval(i.onDisconnect,u(t))}),p=s.onDetach(function(t){for(var e in a)t.child(e).onDisconnect().cancel(),n.$eval(i.onDisconnect,h);a={}});n.$on("$destroy",function(){s.offAttach(l),s.offDetach(p)})}return{require:"firebase",restrict:"A",link:n}}]),t.module("flashpoint").factory("ChildQuery",["validatePath",function(t){function e(t){this.listenerSet=t,this._props={}}return e.prototype.startAt=function(t,e){return this._props.startAtValue=t,e&&(this._props.startAtKey=e),this},e.prototype.endAt=function(t,e){return this._props.endAtValue=t,e&&(this._props.endAtKey=e),this},e.prototype.equalTo=function(t,e){return this._props.equalToValue=t,e&&(this._props.equalToKey=e),this},e.prototype.limitToFirst=function(t){return this._props.limitToFirst=t,this},e.prototype.limitToLast=function(t){return this._props.limitToLast=t,this},e.prototype.orderByKey=function(){return this._props.orderBy="key",this},e.prototype.orderByPriority=function(){return this._props.orderBy="priority",this},e.prototype.orderByChild=function(t){return this._props.orderBy="child",this._props.orderByChild=t,this},e.prototype.of=function(){var e=Array.prototype.slice.call(arguments,0),n=t(e),o=this.listenerSet.root.child(n),i=n+".children";switch(this._props.orderBy||""){case"key":i+=".orderByKey",o=o.orderByKey();break;case"priority":i+=".orderByPriority",o=o.orderByPriority();break;case"child":i+=".orderByChild."+this._props.orderByChild,o=o.orderByChild(this._props.orderByChild)}if(this._props.startAtValue&&this._props.startAtKey?(i+=".startAtValue."+this._props.startAtValue+".startAtKey."+this._props.startAtKey,o=o.startAt(this._props.startAtValue,this._props.startAtKey)):this._props.startAtValue&&(i+=".startAtValue."+this._props.startAtValue,o=o.startAt(this._props.startAtValue)),this._props.endAtValue&&this._props.endAtKey?(i+=".endAtValue."+this._props.endAtValue+".endAtKey."+this._props.endAtKey,o=o.endAt(this._props.endAtValue,this._props.endAtKey)):this._props.endAtValue&&(i+=".endAtValue."+this._props.endAtValue,o=o.endAt(this._props.endAtValue)),this._props.equalToValue&&this._props.equalToKey?(i+=".equalToValue."+this._props.equalToValue+".equalToKey."+this._props.equalToKey,o=o.equalTo(this._props.equalToValue,this._props.equalToKey)):this._props.equalToValue&&(i+=".equalToValue."+this._props.equalToValue,o=o.equalTo(this._props.equalToValue)),this._props.limitToFirst&&(i+=".limitToFirst."+this._props.limitToFirst,o=o.limitToFirst(this._props.limitToFirst)),this._props.limitToLast&&(i+=".limitToLast."+this._props.limitToLast,o=o.limitToLast(this._props.limitToLast)),this.listenerSet.has(i))return this.listenerSet.watchers[i];var s=new r.LiveArray;return this.listenerSet.add(i,s),"child"===this._props.orderBy?s.connect(o,this._props.orderBy,this._props.orderByChild):this._props.orderBy?s.connect(o,this._props.orderBy):s.connect(o),s},e}]),t.module("flashpoint").factory("Feed",["$q",function(e){function r(e,r){if(arguments.length<2)throw new Error("Feed expects at least 2 arguments, got "+arguments.length);t.isArray(e)||(e=[e]),this._queryFn=r,this._positions=e.reduce(function(t,e){return t[e]=void 0,t},{}),this._presence={},this.items=[]}return r.prototype._transformFn=function(t){return t},r.prototype._filterFn=function(){return!0},r.prototype.setTransform=function(t){return this._transformFn=t,this},r.prototype.setSort=function(t){return this._sortFn=t,this},r.prototype.setFilter=function(t){return this._filterFn=t,this},r.prototype.more=function(){var t=this;return t._morePromise||(t._morePromise=e.all(Object.keys(t._positions).map(function(r){return t._queryFn(t.root.child(r),t._positions[r]).then(function(n){var o=[];return n.forEach(function(n){t._presence.hasOwnProperty(n.ref().toString())||(t._presence[n.ref().toString()]=!0,o.push(e.when(t._transformFn(n,t.root))),t._positions[r]=n)}),e.all(o)})})).then(function(e){var r=e.reduce(function(t,e){return t.concat(e)},[]).filter(function(e,r,n){return t._filterFn(e,r,n,t.items)});t._sortFn&&r.sort(t._sortFn),r.forEach(function(e){t.items.push(e)}),t._morePromise=null})),t._morePromise},r.prototype.connect=function(t){return this.disconnect(),this.root=t,this.more()},r.prototype.disconnect=function(){this._positions=Object.keys(this._positions).reduce(function(t,e){return t[e]=void 0,t},{}),this._presence={},this.items.length=0},r}]),t.module("flashpoint").factory("Firebase",function(){return e}).factory("ServerValue",["Firebase",function(t){return t.ServerValue}]).factory("Fireproof",["$rootScope","$q",function(t,e){return r.setNextTick(function(e){t.$evalAsync(e)}),r.bless(e),r}]),t.module("flashpoint").factory("ListenerSet",function(){function t(t,e){function r(){var t={};for(var e in n.watchers)n.watchers[e]&&n.liveWatchers[e]?t[e]=n.watchers[e]:n.remove(e);n.watchers=t,n.liveWatchers={},o=!1}var n=this,o=!1;n.watchers={},n.liveWatchers={},n.values={},n.priorities={},n.errors={},n.root=t,n.scope=e,n.scope.$watch(function(){o||(o=!0,e.$$postDigest(r))})}return t.prototype.add=function(t,e){var r=this;r.liveWatchers[t]=!0,r.watchers[t]||(r.watchers[t]=e?e:r.root.child(t).on("value",function(e){r.errors[t]=null,r.values[t]=e.val(),r.priorities[t]=e.getPriority(),r.scope.$evalAsync()},function(e){r.liveWatchers[t]=!1,r.watchers[t]=null,r.errors[t]=e,r.values[t]=null,r.priorities[t]=null,r.scope.$evalAsync()}))},t.prototype.has=function(t){return this.watchers.hasOwnProperty(t)},t.prototype.remove=function(t){this.watchers[t]&&(this.watchers[t].disconnect?this.watchers[t].disconnect():this.root.child(t).off("value",this.watchers[t]),this.values[t]=null,this.errors[t]=null,this.priorities[t]=null,this.watchers[t]=null)},t.prototype.clear=function(){for(var t in this.watchers)this.remove(t);this.watchers={}},t}),t.module("flashpoint").factory("Page",["$q",function(t){function e(t){this._pagingFn=t,this._pages=[],this._presence={},this.items=[],this.keys=[],this.priorities=[],this.values=[],this.disconnect()}return e.prototype.connect=function(t){return this.disconnect(),this.root=t,this.next()},e.prototype.disconnect=function(){this.root=null,this._pages.length=0,this.items.length=0,this.keys.length=0,this.values.length=0,this.priorities.length=0,this.number=0,this._presence={}},e.prototype._handleSnap=function(t){var e=[],r=this._presence;t.forEach(function(t){r.hasOwnProperty(t.key())||(r[t.key()]=!0,e.push(t))}),e.length>0?(this._pages.push(e),this._setPage(this._pages.length)):this._lastPage=this.number,this._currentOperation=null},e.prototype.next=function(){if(this.hasNext()){if(this._pages.length>this.number)return this._setPage(this.number+1),t.when();if(this._currentOperation)return this._currentOperation;if(0===this._pages.length)return this._currentOperation=this._pagingFn(this.root,null).then(this._handleSnap.bind(this)),this._currentOperation;if(this._pages[this._pages.length-1].length>0){var e=this._pages[this._pages.length-1];return this._currentOperation=this._pagingFn(this.root,e[e.length-1]).then(this._handleSnap.bind(this)),this._currentOperation}return t.when()}return t.when()},e.prototype.hasNext=function(){return this.hasOwnProperty("root")&&this._lastPage!==this.number},e.prototype.hasPrevious=function(){return this.hasOwnProperty("root")&&this.number>1},e.prototype.previous=function(){return this.hasPrevious()&&this._setPage(this.number-1),t.when()},e.prototype.reset=function(){return this.connect(this.root)},e.prototype._setPage=function(t){this.items.length=0,this.keys.length=0,this.values.length=0,this.priorities.length=0,this._pages[t-1].forEach(function(t){this.items.push(t),this.keys.push(t.key()),this.values.push(t.val()),this.priorities.push(t.getPriority())},this),this.number=t},e}]),t.module("flashpoint").factory("validatePath",function(){function t(t){var e=t.join("/");return 0===t.length||""===e||-1!==t.indexOf(null)||-1!==t.indexOf(void 0)?null:e}return t}),o.$inject=["$scope","$q","Firebase","Fireproof","ChildQuery","validatePath","ListenerSet"],t.module("flashpoint").controller("FirebaseCtl",o)});