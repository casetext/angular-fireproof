/*! flashpoint 2.0.1, Â© 2014 J2H2 Inc. MIT License.
 * https://github.com/casetext/flashpoint
 */
!function(t,e){"function"==typeof define&&define.amd?define(["angular","firebase","fireproof"],e):"object"==typeof exports?e(require("angular"),require("firebase"),require("fireproof")):e(t.angular,t.Firebase,t.Fireproof)}(this,function(t,e,r){"use strict";function o(e,r,o,n){return{restrict:"ECA",priority:-350,terminal:!0,link:function(i,a){var s=o.current.locals;a.html(s.$template);var u=e(a.contents());t.forEach(s,function(t,e){"$"!==e.charAt(0)&&"_"!==e.charAt(0)&&(i[e]=t)}),s.$scope=i;var l=r("FirebaseCtl",s);i.fp=l,a.data("$firebaseController",l),a.children().data("$firebaseController",l),n.startRoute(),u(i)}}}function n(e,r,o,n,i,a,s,u,l,p,c,f,h,d){function y(){for(var t in $)$[t]&&!m[t]&&($[t].disconnect?$[t].disconnect():(g.root.child(t).off("value",$[t]),_[t]=null),$[t]=null);m={},w=!1}function v(t){g.auth=t}var g=this,$=g.$$watchers={},m={},_={},A=function(){return r.reject(new Error("No login handler is set for "+g.root))},b=function(){g.root.unauth()},L=A,T=b;g.auth=null;var w=!1;if(o.$watch(function(){w||(w=!0,o.$$postDigest(y))}),g.login=function(t){return r.when(L(g.root,t))},g.setLoginHandler=function(t){L=t||A},g.logout=function(t){return r.when(T(g.root,t))},g.setLogoutHandler=function(t){T=t||b},g.cleanup=function(){L=A,T=b,g.root.offAuth(v),g.root.off(),delete g.root,delete g.auth},g.attachFirebase=function(t){g.root&&g.cleanup(),g.root=new s(new a(t)),g.auth=g.root.getAuth(),g.root.onAuth(v)},g.set=function(){var t=Array.prototype.slice.call(arguments,0),e=t.pop(),r=l(t);return g.root.child(r).set(e)},g.setPriority=function(){var t=Array.prototype.slice.call(arguments,0),e=t.pop(),r=l(t);return g.root.child(r).setPriority(e)},g.setWithPriority=function(){var t=Array.prototype.slice.call(arguments,0),e=t.pop(),r=t.pop(),o=l(t);return g.root.child(o).setWithPriority(r,e)},g.push=function(){var t=Array.prototype.slice.call(arguments,0),e=t.pop(),r=l(t);return g.root.child(r).push(e)},g.update=function(){var t=Array.prototype.slice.call(arguments,0),e=t.pop(),r=l(t);return g.root.child(r).update(e)},g.remove=function(){var t=Array.prototype.slice.call(arguments,0),e=l(t);return g.root.child(e).remove()},g.increment=function(){var e=Array.prototype.slice.call(arguments,0),o=l(e);return g.root.child(o).transaction(function(e){return t.isNumber(e)?e+1:null===e?1:void 0}).then(function(t){return t.committed?void 0:r.reject(new Error("Cannot increment the object at "+o))})},g.decrement=function(){var e=Array.prototype.slice.call(arguments,0),o=l(e);return g.root.child(o).transaction(function(e){return t.isNumber(e)?e-1:null===e?0:void 0}).then(function(t){return t.committed?void 0:r.reject(new Error("Cannot decrement the object at "+o))})},g.transaction=function(){var t=Array.prototype.slice.call(arguments,0),e=t.pop(),o=l(t);return g.root.child(o).transaction(function(t){return e(t)}).then(function(t){return t.committed?void 0:r.reject(new Error("Aborted"))})},g.val=function(){var t=l(Array.prototype.slice.call(arguments,0));if(t)return _.hasOwnProperty(t)||(_[t]=null),m[t]=!0,$[t]||($[t]=g.root.child(t).on("value",function(e){_[t]=e.val(),o.$evalAsync()})),_[t]},g.children=function(){return new u(g.root,$,m)},o.$on("$destroy",function(){t.forEach($,function(t,e){g.root.child(e).off("value",t)}),g.cleanup()}),null!==f&&g.attachFirebase(f),t.isFunction(h))var F=o.$on("flashpointLoadSuccess",function(){F(),n.invoke(h,null,{root:g.root,auth:g.auth})});if(t.isFunction(d)){var V=function(t){n.invoke(d,null,{root:g.root,auth:g.auth,event:t})};o.$on("flashpointLoadError",V),o.$on("flashpointLoadTimeout",V)}t.isFunction(p)&&g.setLoginHandler(function(){return n.invoke(p,null,{root:g.root})}),t.isFunction(c)&&g.setLogoutHandler(function(){return n.invoke(c,null,{root:g.root,auth:g.auth})})}t.module("flashpoint",[]),t.module("flashpoint").directive("firebase",function(){var t,e,r=function(r,o,n,i){var a=function(t){setTimeout(function(){r.$apply(function(){r.$auth=t,n.onAuthChange&&r.$evalAsync(n.onAuthChange)})},0)},s=function(o){t&&o===e||(i.root&&i.root.offAuth(a),i.attachFirebase(o),i.root.onAuth(a),n.loginHandler?i.setLoginHandler(function(t,e){return r.$eval(n.loginHandler,{$root:t,$options:e})}):i.setLoginHandler(),n.logoutHandler?i.setLogoutHandler(function(t,e){return r.$eval(n.logoutHandler,{$root:t,$options:e})}):i.setLogoutHandler(),t=!0,e=o)};n.firebase&&s(n.firebase),r.fp=i,n.$observe("firebase",s)};return{restrict:"A",scope:!0,controller:"FirebaseCtl",priority:1e3,link:{pre:r}}}),t.module("flashpoint").directive("fpPage",["$q","$animate","Fireproof",function(e,r,o){return{restrict:"A",scope:!0,require:"^firebase",link:function(n,i,a,s){var u,l,p=function(t){r.removeClass(i,"fp-paging"),n.$paging=!1,n.$hasPrevious=l.hasPrevious&&1!==n.$pageNumber,n.$hasNext=l.hasNext,n.$keys=t.map(function(t){return t.key()}),n.$values=t.map(function(t){return t.val()}),n.$priorities=t.map(function(t){return t.getPriority()}),a.as&&(n[a.as]=n.$values),a.onPage&&n.$evalAsync(a.onPage)},c=function(t){r.removeClass(i,"fp-paging"),n.$paging=!1,r.addClass(i,"fp-error"),n.$error=t,a.onError&&n.$evalAsync(a.onError)};n.$next=function(){if(l&&!n.$paging&&n.$hasNext){var o;o=parseInt(a.limit)?parseInt(a.limit):5;var s;return s="previous"===l._direction?o+n.$values.length-1:o,r.addClass(i,"fp-paging"),n.$paging=!0,l.next(s).then(function(t){return n.$pageNumber++,s!==o&&(t=t.slice(o-1)),t}).then(p,c)}return t.isDefined(l)?e.when():e.reject(new Error("Pager does not exist. Has fp-page been set yet?"))},n.$previous=function(){if(l&&!n.$paging&&n.$hasPrevious){var o;o=parseInt(a.limit)?parseInt(a.limit):5;var s;return s="next"===l._direction?o+n.$values.length-1:o,r.addClass(i,"fp-paging"),n.$paging=!0,l.previous(s).then(function(t){return n.$pageNumber--,t=t.slice(0,o)}).then(p,c)}return t.isDefined(l)?e.when():e.reject(new Error("Pager does not exist. Has fp-page been set yet?"))},n.$reset=function(){return r.removeClass(i,"fp-paging"),r.removeClass(i,"fp-error"),delete n.$error,n.$pageNumber=0,n.$hasNext=!0,n.$hasPrevious=!1,n.$paging=!1,l=new o.Pager(new o(u)),l._direction="next",n.$next()},a.$observe("fpPage",function(t){t=t||"",0===t.length||t.match(/\/\//)||"/"===t.charAt(0)||"/"===t.charAt(t.length-1)||(u=s.root.child(t),n.$reset())})}}}]),o.$inject=["$compile","$controller","$route","firebaseStatus"],t.module("flashpoint").directive("fpView",o),t.module("flashpoint").factory("ChildQuery",["validatePath",function(t){function e(t,e,r){this.root=t,this.watchers=e,this.liveWatchers=r,this._props={}}return e.prototype.startAt=function(t,e){return this._props.startAtValue=t,e&&(this._props.startAtKey=e),this},e.prototype.endAt=function(t,e){return this._props.endAtValue=t,e&&(this._props.endAtKey=e),this},e.prototype.equalTo=function(t,e){return this._props.equalToValue=t,e&&(this._props.equalToKey=e),this},e.prototype.limitToFirst=function(t){return this._props.limitToFirst=t,this},e.prototype.limitToLast=function(t){return this._props.limitToLast=t,this},e.prototype.orderByKey=function(){return this._props.orderBy="key",this},e.prototype.orderByPriority=function(){return this._props.orderBy="priority",this},e.prototype.orderByChild=function(t){return this._props.orderBy="child",this._props.orderByChild=t,this},e.prototype.of=function(){var e=Array.prototype.slice.call(arguments,0),o=t(e),n=this.root.child(o),i=o+".children";switch(this._props.orderBy||""){case"key":i+=".orderByKey",n=n.orderByKey();break;case"priority":i+=".orderByPriority",n=n.orderByPriority();break;case"child":i+=".orderByChild."+this._props.orderByChild,n=n.orderByChild(this._props.orderByChild)}return this._props.startAtValue&&this._props.startAtKey?(i+=".startAtValue."+this._props.startAtValue+".startAtKey."+this._props.startAtKey,n=n.startAt(this._props.startAtValue,this._props.startAtKey)):this._props.startAtValue&&(i+=".startAtValue."+this._props.startAtValue,n=n.startAt(this._props.startAtValue)),this._props.endAtValue&&this._props.endAtKey?(i+=".endAtValue."+this._props.endAtValue+".endAtKey."+this._props.endAtKey,n=n.endAt(this._props.endAtValue,this._props.endAtKey)):this._props.endAtValue&&(i+=".endAtValue."+this._props.endAtValue,n=n.endAt(this._props.endAtValue)),this._props.equalToValue&&this._props.equalToKey?(i+=".equalToValue."+this._props.equalToValue+".equalToKey."+this._props.equalToKey,n=n.equalTo(this._props.equalToValue,this._props.equalToKey)):this._props.equalToValue&&(i+=".equalToValue."+this._props.equalToValue,n=n.equalTo(this._props.equalToValue)),this._props.limitToFirst&&(i+=".limitToFirst."+this._props.limitToFirst,n=n.limitToFirst(this._props.limitToFirst)),this._props.limitToLast&&(i+=".limitToLast."+this._props.limitToLast,n=n.limitToLast(this._props.limitToLast)),this.liveWatchers[i]=!0,this.watchers[i]||(this.watchers[i]=new r.LiveArray,"child"===this._props.orderBy?this.watchers[i].connect(n,this._props.orderBy,this._props.orderByChild):this._props.orderBy?this.watchers[i].connect(n,this._props.orderBy):this.watchers[i].connect(n)),this.watchers[i]},e}]),t.module("flashpoint").factory("Firebase",function(){return e}).factory("ServerValue",["Firebase",function(t){return t.ServerValue}]).factory("Fireproof",["$rootScope","$q",function(t,e){return r.setNextTick(function(e){t.$evalAsync(e)}),r.bless(e),r}]),t.module("flashpoint").constant("_fpFirebaseUrl",null).constant("_fpOnLoaded",null).constant("_fpOnError",null).constant("_fpHandleLogin",null).constant("_fpHandleLogout",null).constant("fpRoute",function(t){if(!t.firebase)throw new Error('No Firebase URL has been defined in your controller. Please set the "firebase" property in your route definition object.');t.resolve=t.resolve||{};var e=t.firebase;if(delete t.firebase,t.loaded){var r=t.loaded;delete t.loaded,t.resolve._fpOnLoaded=function(){return r}}if(t.error){var o=t.error;delete t.error,t.resolve._fpOnError=function(){return o}}if(t.login){var n=t.login;t.resolve._fpHandleLogin=function(){return n}}if(t.logout){var i=t.logout;delete t.logout,t.resolve._fpHandleLogout=function(){return i}}return t.resolve._fpFirebaseUrl=function(r,o,n,i){var a=new i(new n(e));return r.when().then(function(){return t.challenge&&t.login&&null===a.getAuth()?o.invoke(t.login,null,{root:a,auth:null}):void 0}).then(function(){return t.authorize?o.invoke(t.authorize,null,{root:a,auth:a.getAuth()}):void 0}).then(function(){return e})},t.resolve._fpFirebaseUrl.$inject=["$q","$injector","Firebase","Fireproof"],t}),t.module("flashpoint").value("fpLoadedTimeout",2e4).service("firebaseStatus",["$interval","$timeout","$document","$animate","$rootScope","$log","Fireproof","fpLoadedTimeout",function(t,e,r,o,n,i,a,s){function u(){a.stats.off("finish",l),a.stats.off("error",p),e.cancel(f._deadHand)}function l(){if(0===a.stats.runningOperationCount){u();var t=[];for(var e in a.stats.operationLog)t.push(a.stats.operationLog[e]);t.sort(function(t,e){return t.start-e.start||t.end-e.end}),o.setClass(r,"fp-loaded","fp-loading"),n.$broadcast("flashpointLoadSuccess",t),n.$evalAsync()}}function p(t){u(),n.$broadcast("flashpointLoadError",t)}function c(){a.stats.reset(),a.stats.resetListeners()}var f=this;f.startRoute=function(){c(),a.stats.on("finish",l),a.stats.on("error",p),f._deadHand=e(function(){u(),n.$broadcast("flashpointLoadTimeout")},s),n.$broadcast("flashpointLoadStart"),o.addClass(r,"fp-loading")}}]),t.module("flashpoint").factory("validatePath",function(){function t(t){var e=t.join("/");return 0===t.length||""===e||-1!==t.indexOf(null)||-1!==t.indexOf(void 0)?null:e}return t}),n.$inject=["$log","$q","$scope","$injector","$timeout","Firebase","Fireproof","ChildQuery","validatePath","_fpHandleLogin","_fpHandleLogout","_fpFirebaseUrl","_fpOnLoaded","_fpOnError"],t.module("flashpoint").controller("FirebaseCtl",n)});