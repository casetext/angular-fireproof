/*! flashpoint 3.1.4, Â© 2015 J2H2 Inc. MIT License.
 * https://github.com/casetext/flashpoint
 */
!function(t,e){"function"==typeof define&&define.amd?define(["angular","firebase","fireproof"],e):"object"==typeof exports?e(require("angular"),require("firebase"),require("fireproof")):e(t.angular,t.Firebase,t.Fireproof)}(this,function(t,e,r){"use strict";function n(t,e,r,n){var i,o=n.onAttach(function(){i=t.$watch("fp.connected",function(e){e===!0&&t.$eval(r.onConnect)})}),c=n.onDetach(function(){i&&(i(),i=null)});t.$on("$destroy",function(){n.offAttach(o),n.offDetach(c)})}function i(e,r,n,i,o,c,a){function s(t){d.listenerSet&&d.listenerSet.clear(),d.auth=t,e.$evalAsync()}function u(t){d.connected=t.val(),e.$evalAsync()}function l(t){return d.authenticating=!1,d.authError=null,t}function h(t){return d.authenticating=!0,d.authError=t,r.reject(t)}function f(){d.accountChanging=!1,d.accountError=null}function p(t){return d.accountChanging=!1,d.accountError=t,r.reject(t)}var d=this,y=[],v=[];d.auth=null,d.authError=null,d.accountError=null,d.authenticating=!1,d.accountChanging=!1,d.detachFirebase=function(){d.listenerSet&&(d.listenerSet.clear(),delete d.listenerSet),delete d.connected,d.auth=null,d.authError=null,d.accountError=null,d.authenticating=!1,d.accountChanging=!1,d.root&&(d.root.offAuth(s),d.root.child(".info/connected").off("value",u),d.root.off(),v.forEach(function(t){t(d.root)}),delete d.root),e.$evalAsync()},d.onDetach=function(t){return v.push(t),d.root||t(),t},d.offDetach=function(t){v.splice(v.indexOf(t),1)},d.attachFirebase=function(t){d.root&&d.detachFirebase(),d.root=new o(new i(n(t)(e))),d.listenerSet=new a(d.root,e),d.root.onAuth(s),d.connected=!0,d.root.child(".info/connected").on("value",u),y.forEach(function(t){t(d.root)})},d.onAttach=function(t){return y.push(t),d.root&&t(d.root),t},d.offAttach=function(t){y.splice(y.indexOf(t),1)},d.goOffline=function(){i.goOffline()},d.goOnline=function(){i.goOnline()},d.unauth=function(){d.authError=null,d.accountError=null,d.root.unauth()},d.authWithCustomToken=function(t){return d.authenticating=!0,d.root.authWithCustomToken(t).then(l,h)},d.authAnonymously=function(t){return d.authenticating=!0,d.root.authAnonymously(null,t).then(l,h)},d.authWithPassword=function(t,e){return d.authenticating=!0,d.root.authWithPassword({email:t,password:e}).then(l,h)},d.authWithOAuthPopup=function(t,e){return d.authenticating=!0,d.root.authWithOAuthPopup(t,null,e).then(l,h)},d.authWithOAuthToken=function(t,e,r){return d.authenticating=!0,d.root.authWithOAuthToken(t,e,null,r).then(l,h)},d.createUser=function(t,e){return d.accountChanging=!0,d.root.createUser({email:t,password:e}).then(f,p)},d.removeUser=function(t,e){return d.accountChanging=!0,d.root.removeUser({email:t,password:e}).then(f,p)},d.changeEmail=function(t,e,r){return d.accountChanging=!0,d.root.changeEmail({oldEmail:t,newEmail:e,password:r}).then(f,p)},d.changePassword=function(t,e,r){return d.accountChanging=!0,d.root.changePassword({email:t,oldPassword:e,newPassword:r}).then(f,p)},d.resetPassword=function(t){return d.accountChanging=!0,d.root.resetPassword({email:t}).then(f,p)},d.set=function(){var t=Array.prototype.slice.call(arguments,0),e=t.pop(),r=c(t);return d.root.child(r).set(e)},d.setPriority=function(){var t=Array.prototype.slice.call(arguments,0),e=t.pop(),r=c(t);return d.root.child(r).setPriority(e)},d.setWithPriority=function(){var t=Array.prototype.slice.call(arguments,0),e=t.pop(),r=t.pop(),n=c(t);return d.root.child(n).setWithPriority(r,e)},d.push=function(){var t=Array.prototype.slice.call(arguments,0),e=t.pop(),r=c(t);return d.root.child(r).push(e)},d.update=function(){var t=Array.prototype.slice.call(arguments,0),e=t.pop(),r=c(t);return d.root.child(r).update(e)},d.remove=function(){var t=Array.prototype.slice.call(arguments,0),e=c(t);return d.root.child(e).remove()},d.increment=function(){var e=Array.prototype.slice.call(arguments,0),n=c(e);return d.root.child(n).transaction(function(e){return t.isNumber(e)?e+1:null===e?1:void 0}).then(function(t){return t.committed?void 0:r.reject(new Error("Cannot increment the object at "+n))})},d.decrement=function(){var e=Array.prototype.slice.call(arguments,0),n=c(e);return d.root.child(n).transaction(function(e){return t.isNumber(e)?e-1:null===e?0:void 0}).then(function(t){return t.committed?void 0:r.reject(new Error("Cannot decrement the object at "+n))})},d.transaction=function(){var t=Array.prototype.slice.call(arguments,0),e=t.pop(),n=c(t);return d.root.child(n).transaction(function(t){return e(t)}).then(function(t){return t.committed?void 0:r.reject(new Error("Aborted"))})},d.val=function(){var t=c(Array.prototype.slice.call(arguments,0));if(t&&d.listenerSet)return d.listenerSet.add(t),d.listenerSet.values.hasOwnProperty(t)?d.listenerSet.values[t]:null},d.model=function(){var e=c(Array.prototype.slice.call(arguments,0));return function(r){return e&&d.listenerSet?t.isDefined(r)?d.set(e,r):(d.listenerSet.add(e),d.listenerSet.values.hasOwnProperty(e)?d.listenerSet.values[e]:null):void 0}},d.priority=function(){var t=c(Array.prototype.slice.call(arguments,0));if(t&&d.listenerSet)return d.listenerSet.add(t),d.listenerSet.priorities.hasOwnProperty(t)?d.listenerSet.priorities[t]:null},d.error=function(){var t=c(Array.prototype.slice.call(arguments,0));return t&&d.listenerSet&&d.listenerSet.errors.hasOwnProperty(t)?d.listenerSet.errors[t]:null},d.path=function(){var t=c(Array.prototype.slice.call(arguments,0));return t?t:null},e.$on("$destroy",function(){d.detachFirebase()})}t.module("flashpoint",[]),t.module("flashpoint").directive("firebase",["$animate",function(t){function e(e,r,n,i){var o,c,a=function(t){o&&t===c||"string"==typeof t&&""!==t&&(i.attachFirebase(t),o=!0,c=t)};n.firebase&&a(n.firebase),n.$observe("firebase",a),e.$watch("fp.connected",function(e){e===!0?t.setClass(r,"fp-connected","fp-disconnected"):e===!1?t.setClass(r,"fp-disconnected","fp-connected"):t.setClass(r,[],["fp-connected","fp-disconnected"])}),e.$watch("fp.auth",function(e){void 0===e?t.setClass(r,[],["fp-unauthenticated","fp-authenticated"]):null===e?t.setClass(r,"fp-unauthenticated","fp-authenticated"):t.setClass(r,"fp-authenticated","fp-unauthenticated")}),e.$watch("fp.authError",function(e){e?t.addClass(r,"fp-auth-error"):t.removeClass(r,"fp-auth-error")}),e.$watch("fp.accountError",function(e){e?t.addClass(r,"fp-account-error"):t.removeClass(r,"fp-account-error")})}return{restrict:"A",scope:!0,controller:"FirebaseCtl",controllerAs:"fp",priority:1e3,link:{pre:e}}}]),t.module("flashpoint").directive("fpBindChildren",["$animate","$compile","_fpGetRef",function(e,r,n){function i(i){var o=i[0].querySelector("[fp-child-repeat]"),c=t.element(document.createComment("fp-child-repeat start")),a=t.element(document.createComment("fp-child-repeat end"));if(!o)throw new Error("No fp-child-repeat was found in your fp-bind-children!");return o=t.element(o),o.after(a),o.after(c),o.remove(),function(t,i,s,u){function l(e){for(var r=0;r<t.$children.length;r++)if(t.$children[r].key()===e)return r;return-1}function h(){$&&$(),$=t.$watch(s.fpBindChildren,function(t){if(f(),t)try{g=n(u.root,t),g.on("child_added",p,m),g.on("child_removed",d,m),g.on("child_moved",y,m),g.on("child_changed",v,m)}catch(e){m(e)}})}function f(){e.removeClass(i,"fp-bind-children-error"),g&&(g.off("child_added",p),g.off("child_removed",d),g.off("child_moved",y),g.off("child_changed",v)),g=null,t.$children.forEach(function(t){var e=A[t.key()];e.remove()}),t.$children.length=0}function p(n,a){var s=l(a)+1;t.$children.splice(s,0,n);var u=o.clone(),h=t.$new();r(u)(h);var f=A[a]||c;h.$key=n.key(),h.$value=n.val(),h.$priority=n.getPriority(),h.$index=s,A[n.key()]=u,e.enter(u,i.parent(),f)}function d(r){e.leave(A[r.key()]);var n=l(r.key());t.$children.splice(n,1),e.leave(A[r.key()],i.parent()).then(function(){A[r.key()]=null})}function y(r,n){var o=l(r.key());t.$children.splice(o,1);var c=l(n)+1;t.$children.splice(c,0,r),A[r.key()].scope().$key=r.key(),A[r.key()].scope().$value=r.val(),A[r.key()].scope().$priority=r.getPriority(),A[r.key()].scope().$index=c+1,e.move(A[r.key()],i.parent(),A[n])}function v(r){var n=l(r.key());t.$children.splice(n,1,r),A[r.key()].scope().$key=r.key(),A[r.key()].scope().$value=r.val(),A[r.key()].scope().$priority=r.getPriority(),e.addClass(A[r.key()],"fp-bind-children-changed").then(function(){e.removeClass(A[r.key()],"fp-bind-children-changed")})}function m(r){t.$error=r,e.addClass(i,"fp-bind-children-error")}var g,$,A={};t.$children=[];var _=u.onAttach(h),w=u.onDetach(function(){$&&($(),$=null),f()});t.$on("$destroy",function(){c.remove(),a.remove(),$&&$(),f(),u.offAttach(_),u.offDetach(w)})}}return{restrict:"A",priority:900,scope:!0,require:"^firebase",compile:i}}]),t.module("flashpoint").directive("fpFeed",["$q","Feed",function(t,e){function r(t,r,n,i){var o=i.onAttach(function(r){t.$feed=new e(t.$eval(n.fpFeed),function(e,r){if(n.feedQuery)return t.$eval(n.feedQuery,{$ref:e,$start:r});throw new Error("fp-feed requires feed-query to be set")}),t.$feed.setTransform(function(e,r){return n.feedTransform?t.$eval(n.feedTransform,{$object:e,$root:r}):e}),t.$feed.setFilter(function(e,r,i,o){return n.feedFilter?t.$eval(n.feedFilter,{$object:e,$index:r,$newItems:i,$items:o}):function(){return!0}}),t.$feed.setSort(function(e,r){return n.feedSort?t.$eval(n.feedSort,{$a:e,$b:r,$left:e,$right:r}):e.ref().toString().localeCompare(r.ref().toString())}),t.$feed.connect(r)}),c=i.onDetach(function(){t.$feed.disconnect()});t.$on("$destroy",function(){i.offAttach(o),i.offDetach(c),t.$feed.disconnect()})}return{require:"^firebase",scope:!0,link:r}}]),t.module("flashpoint").constant("FP_DEFAULT_PAGE_SIZE",3).directive("fpPage",["FP_DEFAULT_PAGE_SIZE","Page",function(e,r){function n(n,i,o,c){function a(t,r){return r=parseInt(r),isNaN(r)&&(r=e),function(e,n){var i=e.child(t).orderByPriority();return n?i.startAt(n.getPriority(),n.key()).limitToFirst(r+1):i.limitToFirst(r)}}function s(t,r){return r=parseInt(r),isNaN(r)&&(r=e),function(e,n){var i=e.child(t).orderByKey();return n?i.startAt(n.key()).limitToFirst(r+1):i.limitToFirst(r)}}function u(t,r){return r=parseInt(r),isNaN(r)&&(r=e),function(e,n){var i=e.child(t).orderByValue();return n?i.startAt(n.val(),n.key()).limitToFirst(r+1):i.limitToFirst(r)}}function l(r,n,i){return i=parseInt(i),isNaN(i)&&(i=e),function(e,o){var c=e.child(r).orderByChild(n);if(o){var a=o.val();return a=t.isObject(a)?a[n]:null,c.startAt(a,o.key()).limitToFirst(i+1)}return c.limitToFirst(i)}}var h={$orderByPriority:a,$orderByKey:s,$orderByChild:l,$orderByValue:u},f=c.onAttach(function(t){n.$page=new r(n.$eval(o.fpPage,h)),n.$page.connect(t)}),p=c.onDetach(function(){n.$page.disconnect()});n.$on("$destroy",function(){c.offAttach(f),c.offDetach(p),n.$page.disconnect()})}return{link:n,restrict:"A",priority:750,scope:!0,require:"^firebase"}}]),t.module("flashpoint").directive("onAuth",function(){function t(t,e,r,n){function i(e){r.onAuth&&t.$eval(r.onAuth,{$auth:e})}n.onAttach(function(t){t.onAuth(i)}),n.onDetach(function(t){t.offAuth(i)})}return{priority:750,require:"^firebase",restrict:"A",link:{pre:t}}}),t.module("flashpoint").directive("onConnect",function(){return{require:"firebase",link:n}}),t.module("flashpoint").directive("onDisconnect",["$q","$log","validatePath",function(t,e,r){function n(n,i,o,c){var a={},s=function(t){e.debug('onDisconnect: error evaluating "'+o.onDisconnect+'": '+t.code),o.onDisconnectError&&n.$eval(o.onDisconnectError,{$error:t})},u=function(e){return{$set:function(){var n=Array.prototype.slice.call(arguments,0),i=n.pop(),o=r(n);return o?(a[o]=!0,e.child(o).onDisconnect().set(i)["catch"](s)):t.reject(new Error("Invalid path"))},$update:function(){var n=Array.prototype.slice.call(arguments,0),i=n.pop(),o=r(n);return o?(a[o]=!0,e.child(o).onDisconnect().update(i)["catch"](s)):t.reject(new Error("Invalid path"))},$setWithPriority:function(){var n=Array.prototype.slice.call(arguments,0),i=n.pop(),o=n.pop(),c=r(n);return c?(a[c]=!0,e.child(c).onDisconnect().setWithPriority(o,i)["catch"](s)):t.reject(new Error("Invalid path"))},$remove:function(){var n=Array.prototype.slice.call(arguments,0),i=r(n);return i?(a[i]=!0,e.child(i).onDisconnect().remove()["catch"](s)):t.reject(new Error("Invalid path"))}}},l={$set:c.set.bind(c),$remove:c.remove.bind(c),$setWithPriority:c.setWithPriority.bind(c),$update:c.update.bind(c)},h=c.onAttach(function(t){n.$eval(o.onDisconnect,u(t))}),f=c.onDetach(function(t){for(var e in a)t.child(e).onDisconnect().cancel(),n.$eval(o.onDisconnect,l);a={}});n.$on("$destroy",function(){c.offAttach(h),c.offDetach(f)})}return{require:"firebase",restrict:"A",link:n}}]),t.module("flashpoint").filter("orderByKey",function(){return function e(r){return t.isArray(r)?r.map(e):t.isString(r)?r+".orderByKey":null}}).filter("orderByValue",function(){return function e(r){return t.isArray(r)?r.map(e):t.isString(r)?r+".orderByValue":null}}).filter("orderByPriority",function(){return function e(r){return t.isArray(r)?r.map(e):t.isString(r)?r+".orderByPriority":null}}).filter("orderByChild",function(){return function e(r,n){return t.isArray(r)?r.map(function(t){return e(t,n)}):t.isString(r)&&t.isString(n)&&n.length>0?r+".orderByChild:"+JSON.stringify(n):null}}).filter("startAt",function(){return function e(r,n,i){return t.isArray(r)?r.map(function(t){return e(t,n,i)}):void 0===n?null:(r+=".startAt:"+JSON.stringify(n),t.isString(i)||t.isNumber(i)?r+":"+JSON.stringify(i):r)}}).filter("endAt",function(){return function e(r,n,i){return t.isArray(r)?r.map(function(t){return e(t,n,i)}):void 0===n?null:(r+=".endAt:"+JSON.stringify(n),t.isString(i)||t.isNumber(i)?r+":"+JSON.stringify(i):r)}}).filter("limitToFirst",function(){return function e(r,n){return n=parseInt(n),isNaN(n)?null:t.isArray(r)?r.map(function(t){return e(t,n)}):r+".limitToFirst:"+JSON.stringify(n)}}).filter("limitToLast",function(){return function e(r,n){return n=parseInt(n),isNaN(n)?null:t.isArray(r)?r.map(function(t){return e(t,n)}):r+".limitToLast:"+JSON.stringify(n)}}).constant("_fpGetRef",function o(e,r){if(t.isArray(r))return r.map(function(t){return o(e,t)});if(t.isString(r)){var n=r.split(/\./g),i=e.child(n.shift());return n.reduce(function(t,e){var r=e.split(":")[0],n=e.split(":").slice(1).map(function(t){return JSON.parse(t)});switch(r){case"orderByKey":case"orderByValue":case"orderByPriority":return t[r]();case"orderByChild":case"startAt":case"endAt":case"limitToFirst":case"limitToLast":return t[r].apply(t,n)}},i)}return null}),t.module("flashpoint").factory("Feed",["$q",function(e){function r(e,r){if(arguments.length<2)throw new Error("Feed expects at least 2 arguments, got "+arguments.length);t.isArray(e)||(e=[e]),this._queryFn=r,this._positions=e.reduce(function(t,e){return t[e]=void 0,t},{}),this._presence={},this.items=[]}return r.prototype._transformFn=function(t){return t},r.prototype._filterFn=function(){return!0},r.prototype.setTransform=function(t){return this._transformFn=t,this},r.prototype.setSort=function(t){return this._sortFn=t,this},r.prototype.setFilter=function(t){return this._filterFn=t,this},r.prototype.more=function(){var t=this;return t._morePromise||(t._morePromise=e.all(Object.keys(t._positions).map(function(r){return t._queryFn(t.root.child(r),t._positions[r]).then(function(n){var i=[];return n.forEach(function(n){t._presence.hasOwnProperty(n.ref().toString())||(t._presence[n.ref().toString()]=!0,i.push(e.when(t._transformFn(n,t.root))),t._positions[r]=n)}),e.all(i)})})).then(function(e){var r=e.reduce(function(t,e){return t.concat(e)},[]).filter(function(e,r,n){return t._filterFn(e,r,n,t.items)});t._sortFn&&r.sort(t._sortFn),r.forEach(function(e){t.items.push(e)}),t._morePromise=null})),t._morePromise},r.prototype.connect=function(t){return this.disconnect(),this.root=t,this.more()},r.prototype.disconnect=function(){this._positions=Object.keys(this._positions).reduce(function(t,e){return t[e]=void 0,t},{}),this._presence={},this.items.length=0},r}]),t.module("flashpoint").factory("Firebase",function(){return e}).factory("ServerValue",["Firebase",function(t){return t.ServerValue}]).factory("Fireproof",["$rootScope","$q",function(t,e){return r.setNextTick(function(e){t.$evalAsync(e)}),r.bless(e),r}]),t.module("flashpoint").factory("ListenerSet",function(){function t(t,e){function r(){var t={};for(var e in n.watchers)n.watchers[e]&&n.liveWatchers[e]?t[e]=n.watchers[e]:n.remove(e);n.watchers=t,n.liveWatchers={},i=!1}var n=this,i=!1;n.watchers={},n.liveWatchers={},n.values={},n.priorities={},n.errors={},n.root=t,n.scope=e,n.scope.$watch(function(){i||(i=!0,e.$$postDigest(r))})}return t.prototype.add=function(t){var e=this;e.liveWatchers[t]=!0,e.watchers[t]||(e.watchers[t]=e.root.child(t).on("value",function(r){e.errors[t]=null,e.values[t]=r.val(),e.priorities[t]=r.getPriority(),e.scope.$evalAsync()},function(r){e.liveWatchers[t]=!1,e.watchers[t]=null,e.errors[t]=r,e.values[t]=null,e.priorities[t]=null,e.scope.$evalAsync()}))},t.prototype.has=function(t){return this.watchers.hasOwnProperty(t)},t.prototype.remove=function(t){this.watchers[t]&&(this.watchers[t].disconnect?this.watchers[t].disconnect():this.root.child(t).off("value",this.watchers[t]),this.values[t]=null,this.errors[t]=null,this.priorities[t]=null,this.watchers[t]=null)},t.prototype.clear=function(){for(var t in this.watchers)this.remove(t);this.watchers={}},t}),t.module("flashpoint").factory("Page",["$q",function(t){function e(t){this._pagingFn=t,this._pages=[],this._presence={},this.items=[],this.keys=[],this.priorities=[],this.values=[],this.disconnect()}return e.prototype.connect=function(t){return this.disconnect(),this.root=t,this.next()},e.prototype.disconnect=function(){this.root=null,this._pages.length=0,this.items.length=0,this.keys.length=0,this.values.length=0,this.priorities.length=0,this.number=0,this._presence={}},e.prototype._handleSnap=function(t){var e=[],r=this._presence;t.forEach(function(t){r.hasOwnProperty(t.key())||(r[t.key()]=!0,e.push(t))}),e.length>0?(this._pages.push(e),this._setPage(this._pages.length)):this._lastPage=this.number,this._currentOperation=null},e.prototype.next=function(){if(this.hasNext()){if(this._pages.length>this.number)return this._setPage(this.number+1),t.when();if(this._currentOperation)return this._currentOperation;if(0===this._pages.length)return this._currentOperation=this._pagingFn(this.root,null).then(this._handleSnap.bind(this)),this._currentOperation;if(this._pages[this._pages.length-1].length>0){var e=this._pages[this._pages.length-1];return this._currentOperation=this._pagingFn(this.root,e[e.length-1]).then(this._handleSnap.bind(this)),this._currentOperation}return t.when()}return t.when()},e.prototype.hasNext=function(){return this.hasOwnProperty("root")&&this._lastPage!==this.number},e.prototype.hasPrevious=function(){return this.hasOwnProperty("root")&&this.number>1},e.prototype.previous=function(){return this.hasPrevious()&&this._setPage(this.number-1),t.when()},e.prototype.reset=function(){return this.connect(this.root)},e.prototype._setPage=function(t){this.items.length=0,this.keys.length=0,this.values.length=0,this.priorities.length=0,this._pages[t-1].forEach(function(t){this.items.push(t),this.keys.push(t.key()),this.values.push(t.val()),this.priorities.push(t.getPriority())},this),this.number=t},e}]),t.module("flashpoint").factory("validatePath",function(){function t(t){var e=t.join("/");return 0===t.length||""===e||-1!==t.indexOf(null)||-1!==t.indexOf(void 0)?null:e}return t}),i.$inject=["$scope","$q","$interpolate","Firebase","Fireproof","validatePath","ListenerSet"],t.module("flashpoint").controller("FirebaseCtl",i)});