/*! flashpoint 3.0.0-beta.1, Â© 2015 J2H2 Inc. MIT License.
 * https://github.com/casetext/flashpoint
 */
!function(t,e){"function"==typeof define&&define.amd?define(["angular","firebase","fireproof"],e):"object"==typeof exports?e(require("angular"),require("firebase"),require("fireproof")):e(t.angular,t.Firebase,t.Fireproof)}(this,function(t,e,n){"use strict";function r(t,e,n,r){var i,o=r.onAttach(function(){i=t.$watch("fp.connected",function(e){e===!0&&t.$eval(n.onConnect)})}),c=r.onDetach(function(){i&&(i(),i=null)});t.$on("$destroy",function(){r.offAttach(o),r.offDetach(c)})}function i(e,n,r,i,o,c){function a(t){p.listenerSet&&p.listenerSet.clear(),p.auth=t,e.$evalAsync()}function s(t){p.connected=t.val(),e.$evalAsync()}function u(t){return p.authenticating=!1,p.authError=null,t}function l(t){return p.authenticating=!0,p.authError=t,n.reject(t)}function h(){p.accountChanging=!1,p.accountError=null}function f(t){return p.accountChanging=!1,p.accountError=t,n.reject(t)}var p=this,d=[],y=[];p.auth=null,p.authError=null,p.accountError=null,p.authenticating=!1,p.accountChanging=!1,p.detachFirebase=function(){p.listenerSet&&(p.listenerSet.clear(),delete p.listenerSet),p.root.offAuth(a),p.root.child(".info/connected").off("value",s),delete p.connected,p.root.off(),p.auth=null,p.authError=null,p.accountError=null,p.authenticating=!1,p.accountChanging=!1,y.forEach(function(t){t(p.root)}),delete p.root,e.$evalAsync()},p.onDetach=function(t){return y.push(t),p.root||t(),t},p.offDetach=function(t){y.splice(y.indexOf(t),1)},p.attachFirebase=function(t){p.root&&p.detachFirebase(),p.root=new i(new r(t)),p.listenerSet=new c(p.root,e),p.root.onAuth(a),p.connected=!0,p.root.child(".info/connected").on("value",s),d.forEach(function(t){t(p.root)})},p.onAttach=function(t){return d.push(t),p.root&&t(p.root),t},p.offAttach=function(t){d.splice(d.indexOf(t),1)},p.goOffline=function(){r.goOffline()},p.goOnline=function(){r.goOnline()},p.unauth=function(){p.authError=null,p.accountError=null,p.root.unauth()},p.authWithCustomToken=function(t){return p.authenticating=!0,p.root.authWithCustomToken(t).then(u,l)},p.authAnonymously=function(t){return p.authenticating=!0,p.root.authAnonymously(null,t).then(u,l)},p.authWithPassword=function(t,e){return p.authenticating=!0,p.root.authWithPassword({email:t,password:e}).then(u,l)},p.authWithOAuthPopup=function(t,e){return p.authenticating=!0,p.root.authWithOAuthPopup(t,null,e).then(u,l)},p.authWithOAuthToken=function(t,e,n){return p.authenticating=!0,p.root.authWithOAuthToken(t,e,null,n).then(u,l)},p.createUser=function(t,e){return p.accountChanging=!0,p.root.createUser({email:t,password:e}).then(h,f)},p.removeUser=function(t,e){return p.accountChanging=!0,p.root.removeUser({email:t,password:e}).then(h,f)},p.changeEmail=function(t,e,n){return p.accountChanging=!0,p.root.changeEmail({oldEmail:t,newEmail:e,password:n}).then(h,f)},p.changePassword=function(t,e,n){return p.accountChanging=!0,p.root.changePassword({email:t,oldPassword:e,newPassword:n}).then(h,f)},p.resetPassword=function(t){return p.accountChanging=!0,p.root.resetPassword({email:t}).then(h,f)},p.set=function(){var t=Array.prototype.slice.call(arguments,0),e=t.pop(),n=o(t);return p.root.child(n).set(e)},p.setPriority=function(){var t=Array.prototype.slice.call(arguments,0),e=t.pop(),n=o(t);return p.root.child(n).setPriority(e)},p.setWithPriority=function(){var t=Array.prototype.slice.call(arguments,0),e=t.pop(),n=t.pop(),r=o(t);return p.root.child(r).setWithPriority(n,e)},p.push=function(){var t=Array.prototype.slice.call(arguments,0),e=t.pop(),n=o(t);return p.root.child(n).push(e)},p.update=function(){var t=Array.prototype.slice.call(arguments,0),e=t.pop(),n=o(t);return p.root.child(n).update(e)},p.remove=function(){var t=Array.prototype.slice.call(arguments,0),e=o(t);return p.root.child(e).remove()},p.increment=function(){var e=Array.prototype.slice.call(arguments,0),r=o(e);return p.root.child(r).transaction(function(e){return t.isNumber(e)?e+1:null===e?1:void 0}).then(function(t){return t.committed?void 0:n.reject(new Error("Cannot increment the object at "+r))})},p.decrement=function(){var e=Array.prototype.slice.call(arguments,0),r=o(e);return p.root.child(r).transaction(function(e){return t.isNumber(e)?e-1:null===e?0:void 0}).then(function(t){return t.committed?void 0:n.reject(new Error("Cannot decrement the object at "+r))})},p.transaction=function(){var t=Array.prototype.slice.call(arguments,0),e=t.pop(),r=o(t);return p.root.child(r).transaction(function(t){return e(t)}).then(function(t){return t.committed?void 0:n.reject(new Error("Aborted"))})},p.val=function(){var t=o(Array.prototype.slice.call(arguments,0));if(t)return p.listenerSet.add(t),p.listenerSet.values.hasOwnProperty(t)?p.listenerSet.values[t]:null},p.priority=function(){var t=o(Array.prototype.slice.call(arguments,0));if(t)return p.listenerSet.add(t),p.listenerSet.priorities.hasOwnProperty(t)?p.listenerSet.priorities[t]:null},p.error=function(){var t=o(Array.prototype.slice.call(arguments,0));return t&&p.listenerSet.errors.hasOwnProperty(t)?p.listenerSet.errors[t]:null},p.path=function(){var t=o(Array.prototype.slice.call(arguments,0));return t?t:null},e.$on("$destroy",function(){p.detachFirebase()})}t.module("flashpoint",[]),t.module("flashpoint").directive("firebase",["$animate",function(t){function e(e,i,o,c){var a=function(t){n&&t===r||(c.attachFirebase(t),n=!0,r=t)};o.firebase&&a(o.firebase),o.$observe("firebase",a),e.$watch("fp.connected",function(e){e===!0?t.setClass(i,"fp-connected","fp-disconnected"):e===!1?t.setClass(i,"fp-disconnected","fp-connected"):t.setClass(i,[],["fp-connected","fp-disconnected"])}),e.$watch("fp.auth",function(e){void 0===e?t.setClass(i,[],["fp-unauthenticated","fp-authenticated"]):null===e?t.setClass(i,"fp-unauthenticated","fp-authenticated"):t.setClass(i,"fp-authenticated","fp-unauthenticated")}),e.$watch("fp.authError",function(e){e?t.addClass(i,"fp-auth-error"):t.removeClass(i,"fp-auth-error")}),e.$watch("fp.accountError",function(e){e?t.addClass(i,"fp-account-error"):t.removeClass(i,"fp-account-error")})}var n,r;return{restrict:"A",scope:!0,controller:"FirebaseCtl",controllerAs:"fp",priority:1e3,link:{pre:e}}}]),t.module("flashpoint").directive("fpBindChildren",["$animate","$compile","_fpGetRef",function(e,n,r){function i(i){var o=i[0].querySelector("[fp-child-repeat]"),c=t.element(document.createComment("fp-child-repeat start")),a=t.element(document.createComment("fp-child-repeat end"));if(!o)throw new Error("No fp-child-repeat was found in your fp-bind-children!");return o=t.element(o),o.after(a),o.after(c),o.remove(),function(t,i,s,u){function l(e){for(var n=0;n<t.$children.length;n++)if(t.$children[n].key()===e)return n;return-1}function h(){$&&$(),$=t.$watch(s.fpBindChildren,function(t){if(f(),t)try{g=r(u.root,t),g.on("child_added",p,m),g.on("child_removed",d,m),g.on("child_moved",y,m),g.on("child_changed",v,m)}catch(e){m(e)}})}function f(){e.removeClass(i,"fp-bind-children-error"),g&&(g.off("child_added",p),g.off("child_removed",d),g.off("child_moved",y),g.off("child_changed",v)),g=null,t.$children.forEach(function(t){var e=_[t.key()];e.remove()}),t.$children.length=0}function p(r,a){var s=l(a)+1;t.$children.splice(s,0,r);var u=o.clone(),h=t.$new();n(u)(h);var f=_[a]||c;h.$key=r.key(),h.$value=r.val(),h.$priority=r.getPriority(),h.$index=s,_[r.key()]=u,e.enter(u,i.parent(),f)}function d(n){e.leave(_[n.key()]);var r=l(n.key());t.$children.splice(r,1),e.leave(_[n.key()],i.parent()).then(function(){_[n.key()]=null})}function y(n,r){var o=l(n.key());t.$children.splice(o,1);var c=l(r)+1;t.$children.splice(c,0,n),_[n.key()].scope().$key=n.key(),_[n.key()].scope().$value=n.val(),_[n.key()].scope().$priority=n.getPriority(),_[n.key()].scope().$index=c+1,e.move(_[n.key()],i.parent(),_[r])}function v(n){var r=l(n.key());t.$children.splice(r,1,n),_[n.key()].scope().$key=n.key(),_[n.key()].scope().$value=n.val(),_[n.key()].scope().$priority=n.getPriority(),e.addClass(_[n.key()],"fp-bind-children-changed").then(function(){e.removeClass(_[n.key()],"fp-bind-children-changed")})}function m(n){t.$error=n,e.addClass(i,"fp-bind-children-error")}var g,$,_={};t.$children=[];var w=u.onAttach(h),A=u.onDetach(function(){$&&($(),$=null),f()});t.$on("$destroy",function(){c.remove(),a.remove(),$&&$(),f(),u.offAttach(w),u.offDetach(A)})}}return{restrict:"A",priority:900,scope:!0,require:"^firebase",compile:i}}]),t.module("flashpoint").directive("fpFeed",["$q","Feed",function(t,e){function n(t,n,r,i){var o=i.onAttach(function(n){t.$feed=new e(t.$eval(r.fpFeed),function(e,n){if(r.feedQuery)return t.$eval(r.feedQuery,{$ref:e,$start:n});throw new Error("fp-feed requires feed-query to be set")}),t.$feed.setTransform(function(e,n){return r.feedTransform?t.$eval(r.feedTransform,{$object:e,$root:n}):e}),t.$feed.setFilter(function(e,n,i,o){return r.feedFilter?t.$eval(r.feedFilter,{$object:e,$index:n,$newItems:i,$items:o}):function(){return!0}}),t.$feed.setSort(function(e,n){return r.feedSort?t.$eval(r.feedSort,{$a:e,$b:n,$left:e,$right:n}):e.ref().toString().localeCompare(n.ref().toString())}),t.$feed.connect(n)}),c=i.onDetach(function(){t.$feed.disconnect()});t.$on("$destroy",function(){i.offAttach(o),i.offDetach(c),t.$feed.disconnect()})}return{require:"^firebase",scope:!0,link:n}}]),t.module("flashpoint").constant("FP_DEFAULT_PAGE_SIZE",3).directive("fpPage",["FP_DEFAULT_PAGE_SIZE","Page",function(e,n){function r(r,i,o,c){function a(t,n){return n=parseInt(n),isNaN(n)&&(n=e),function(e,r){var i=e.child(t).orderByPriority();return r?i.startAt(r.getPriority(),r.key()).limitToFirst(n+1):i.limitToFirst(n)}}function s(t,n){return n=parseInt(n),isNaN(n)&&(n=e),function(e,r){var i=e.child(t).orderByKey();return r?i.startAt(r.key()).limitToFirst(n+1):i.limitToFirst(n)}}function u(t,n){return n=parseInt(n),isNaN(n)&&(n=e),function(e,r){var i=e.child(t).orderByValue();return r?i.startAt(r.val(),r.key()).limitToFirst(n+1):i.limitToFirst(n)}}function l(n,r,i){return i=parseInt(i),isNaN(i)&&(i=e),function(e,o){var c=e.child(n).orderByChild(r);if(o){var a=o.val();return a=t.isObject(a)?a[r]:null,c.startAt(a,o.key()).limitToFirst(i+1)}return c.limitToFirst(i)}}var h={$orderByPriority:a,$orderByKey:s,$orderByChild:l,$orderByValue:u},f=c.onAttach(function(t){r.$page=new n(r.$eval(o.fpPage,h)),r.$page.connect(t)}),p=c.onDetach(function(){r.$page.disconnect()});r.$on("$destroy",function(){c.offAttach(f),c.offDetach(p),r.$page.disconnect()})}return{link:r,restrict:"A",priority:750,scope:!0,require:"^firebase"}}]),t.module("flashpoint").directive("onAuth",function(){function t(t,e,n,r){function i(e){n.onAuth&&t.$eval(n.onAuth,{$auth:e})}r.onAttach(function(t){t.onAuth(i)}),r.onDetach(function(t){t.offAuth(i)})}return{priority:750,require:"^firebase",restrict:"A",link:{pre:t}}}),t.module("flashpoint").directive("onConnect",function(){return{require:"firebase",link:r}}),t.module("flashpoint").directive("onDisconnect",["$q","$log","validatePath",function(t,e,n){function r(r,i,o,c){var a={},s=function(t){e.debug('onDisconnect: error evaluating "'+o.onDisconnect+'": '+t.code),o.onDisconnectError&&r.$eval(o.onDisconnectError,{$error:t})},u=function(e){return{$set:function(){var r=Array.prototype.slice.call(arguments,0),i=r.pop(),o=n(r);return o?(a[o]=!0,e.child(o).onDisconnect().set(i)["catch"](s)):t.reject(new Error("Invalid path"))},$update:function(){var r=Array.prototype.slice.call(arguments,0),i=r.pop(),o=n(r);return o?(a[o]=!0,e.child(o).onDisconnect().update(i)["catch"](s)):t.reject(new Error("Invalid path"))},$setWithPriority:function(){var r=Array.prototype.slice.call(arguments,0),i=r.pop(),o=r.pop(),c=n(r);return c?(a[c]=!0,e.child(c).onDisconnect().setWithPriority(o,i)["catch"](s)):t.reject(new Error("Invalid path"))},$remove:function(){var r=Array.prototype.slice.call(arguments,0),i=n(r);return i?(a[i]=!0,e.child(i).onDisconnect().remove()["catch"](s)):t.reject(new Error("Invalid path"))}}},l={$set:c.set.bind(c),$remove:c.remove.bind(c),$setWithPriority:c.setWithPriority.bind(c),$update:c.update.bind(c)},h=c.onAttach(function(t){r.$eval(o.onDisconnect,u(t))}),f=c.onDetach(function(t){for(var e in a)t.child(e).onDisconnect().cancel(),r.$eval(o.onDisconnect,l);a={}});r.$on("$destroy",function(){c.offAttach(h),c.offDetach(f)})}return{require:"firebase",restrict:"A",link:r}}]),t.module("flashpoint").filter("orderByKey",function(){return function(e){return t.isString(e)?e+".orderByKey":null}}).filter("orderByValue",function(){return function(e){return t.isString(e)?e+".orderByValue":null}}).filter("orderByPriority",function(){return function(e){return t.isString(e)?e+".orderByPriority":null}}).filter("orderByChild",function(){return function(e,n){return t.isString(e)&&t.isString(n)&&0!==n.length?e+".orderByChild:"+JSON.stringify(n):null}}).filter("startAt",function(){return function(e,n,r){return void 0===n?null:(e+=".startAt:"+JSON.stringify(n),t.isString(r)||t.isNumber(r)?e+":"+JSON.stringify(r):e)}}).filter("endAt",function(){return function(e,n,r){return void 0===n?null:(e+=".endAt:"+JSON.stringify(n),t.isString(r)||t.isNumber(r)?e+":"+JSON.stringify(r):e)}}).filter("limitToFirst",function(){return function(t,e){return e=parseInt(e),isNaN(e)?null:t+".limitToFirst:"+JSON.stringify(e)}}).filter("limitToLast",function(){return function(t,e){return e=parseInt(e),isNaN(e)?null:t+".limitToLast:"+JSON.stringify(e)}}).constant("_fpGetRef",function(t,e){if(null===e)return null;var n=e.split(/\./g),r=t.child(n.shift());return n.reduce(function(t,e){var n=e.split(":")[0],r=e.split(":").slice(1).map(function(t){return JSON.parse(t)});switch(n){case"orderByKey":case"orderByValue":case"orderByPriority":return t[n]();case"orderByChild":case"startAt":case"endAt":case"limitToFirst":case"limitToLast":return t[n].apply(t,r)}},r)}),t.module("flashpoint").factory("Feed",["$q",function(e){function n(e,n){if(arguments.length<2)throw new Error("Feed expects at least 2 arguments, got "+arguments.length);t.isArray(e)||(e=[e]),this._queryFn=n,this._positions=e.reduce(function(t,e){return t[e]=void 0,t},{}),this._presence={},this.items=[]}return n.prototype._transformFn=function(t){return t},n.prototype._filterFn=function(){return!0},n.prototype.setTransform=function(t){return this._transformFn=t,this},n.prototype.setSort=function(t){return this._sortFn=t,this},n.prototype.setFilter=function(t){return this._filterFn=t,this},n.prototype.more=function(){var t=this;return t._morePromise||(t._morePromise=e.all(Object.keys(t._positions).map(function(n){return t._queryFn(t.root.child(n),t._positions[n]).then(function(r){var i=[];return r.forEach(function(r){t._presence.hasOwnProperty(r.ref().toString())||(t._presence[r.ref().toString()]=!0,i.push(e.when(t._transformFn(r,t.root))),t._positions[n]=r)}),e.all(i)})})).then(function(e){var n=e.reduce(function(t,e){return t.concat(e)},[]).filter(function(e,n,r){return t._filterFn(e,n,r,t.items)});t._sortFn&&n.sort(t._sortFn),n.forEach(function(e){t.items.push(e)}),t._morePromise=null})),t._morePromise},n.prototype.connect=function(t){return this.disconnect(),this.root=t,this.more()},n.prototype.disconnect=function(){this._positions=Object.keys(this._positions).reduce(function(t,e){return t[e]=void 0,t},{}),this._presence={},this.items.length=0},n}]),t.module("flashpoint").factory("Firebase",function(){return e}).factory("ServerValue",["Firebase",function(t){return t.ServerValue}]).factory("Fireproof",["$rootScope","$q",function(t,e){return n.setNextTick(function(e){t.$evalAsync(e)}),n.bless(e),n}]),t.module("flashpoint").factory("ListenerSet",function(){function t(t,e){function n(){var t={};for(var e in r.watchers)r.watchers[e]&&r.liveWatchers[e]?t[e]=r.watchers[e]:r.remove(e);r.watchers=t,r.liveWatchers={},i=!1}var r=this,i=!1;r.watchers={},r.liveWatchers={},r.values={},r.priorities={},r.errors={},r.root=t,r.scope=e,r.scope.$watch(function(){i||(i=!0,e.$$postDigest(n))})}return t.prototype.add=function(t){var e=this;e.liveWatchers[t]=!0,e.watchers[t]||(e.watchers[t]=e.root.child(t).on("value",function(n){e.errors[t]=null,e.values[t]=n.val(),e.priorities[t]=n.getPriority(),e.scope.$evalAsync()},function(n){e.liveWatchers[t]=!1,e.watchers[t]=null,e.errors[t]=n,e.values[t]=null,e.priorities[t]=null,e.scope.$evalAsync()}))},t.prototype.has=function(t){return this.watchers.hasOwnProperty(t)},t.prototype.remove=function(t){this.watchers[t]&&(this.watchers[t].disconnect?this.watchers[t].disconnect():this.root.child(t).off("value",this.watchers[t]),this.values[t]=null,this.errors[t]=null,this.priorities[t]=null,this.watchers[t]=null)},t.prototype.clear=function(){for(var t in this.watchers)this.remove(t);this.watchers={}},t}),t.module("flashpoint").factory("Page",["$q",function(t){function e(t){this._pagingFn=t,this._pages=[],this._presence={},this.items=[],this.keys=[],this.priorities=[],this.values=[],this.disconnect()}return e.prototype.connect=function(t){return this.disconnect(),this.root=t,this.next()},e.prototype.disconnect=function(){this.root=null,this._pages.length=0,this.items.length=0,this.keys.length=0,this.values.length=0,this.priorities.length=0,this.number=0,this._presence={}},e.prototype._handleSnap=function(t){var e=[],n=this._presence;t.forEach(function(t){n.hasOwnProperty(t.key())||(n[t.key()]=!0,e.push(t))}),e.length>0?(this._pages.push(e),this._setPage(this._pages.length)):this._lastPage=this.number,this._currentOperation=null},e.prototype.next=function(){if(this.hasNext()){if(this._pages.length>this.number)return this._setPage(this.number+1),t.when();if(this._currentOperation)return this._currentOperation;if(0===this._pages.length)return this._currentOperation=this._pagingFn(this.root,null).then(this._handleSnap.bind(this)),this._currentOperation;if(this._pages[this._pages.length-1].length>0){var e=this._pages[this._pages.length-1];return this._currentOperation=this._pagingFn(this.root,e[e.length-1]).then(this._handleSnap.bind(this)),this._currentOperation}return t.when()}return t.when()},e.prototype.hasNext=function(){return this.hasOwnProperty("root")&&this._lastPage!==this.number},e.prototype.hasPrevious=function(){return this.hasOwnProperty("root")&&this.number>1},e.prototype.previous=function(){return this.hasPrevious()&&this._setPage(this.number-1),t.when()},e.prototype.reset=function(){return this.connect(this.root)},e.prototype._setPage=function(t){this.items.length=0,this.keys.length=0,this.values.length=0,this.priorities.length=0,this._pages[t-1].forEach(function(t){this.items.push(t),this.keys.push(t.key()),this.values.push(t.val()),this.priorities.push(t.getPriority())},this),this.number=t},e}]),t.module("flashpoint").factory("validatePath",function(){function t(t){var e=t.join("/");return 0===t.length||""===e||-1!==t.indexOf(null)||-1!==t.indexOf(void 0)?null:e}return t}),i.$inject=["$scope","$q","Firebase","Fireproof","validatePath","ListenerSet"],t.module("flashpoint").controller("FirebaseCtl",i)});