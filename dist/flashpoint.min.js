/*! flashpoint 2.1.0, Â© 2015 J2H2 Inc. MIT License.
 * https://github.com/casetext/flashpoint
 */
!function(t,e){"function"==typeof define&&define.amd?define(["angular","firebase","fireproof"],e):"object"==typeof exports?e(require("angular"),require("firebase"),require("fireproof")):e(t.angular,t.Firebase,t.Fireproof)}(this,function(t,e,r){"use strict";function o(e,r,o,i,n,s,a,p,l,u){function c(t){h.listenerSet.clear(),h.auth=t,o.$evalAsync()}var h=this;h.auth=null,h.cleanup=function(){h.listenerSet.clear(),h.root.offAuth(c),h.root.off(),delete h.root,delete h.auth,o.$evalAsync()},h.attachFirebase=function(t){h.root&&h.cleanup(),h.root=new a(new s(t)),h.listenerSet=new u(h.root,o),h.auth=h.root.getAuth(),h.root.onAuth(c)},h.set=function(){var t=Array.prototype.slice.call(arguments,0),e=t.pop(),r=l(t);return h.root.child(r).set(e)},h.setPriority=function(){var t=Array.prototype.slice.call(arguments,0),e=t.pop(),r=l(t);return h.root.child(r).setPriority(e)},h.setWithPriority=function(){var t=Array.prototype.slice.call(arguments,0),e=t.pop(),r=t.pop(),o=l(t);return h.root.child(o).setWithPriority(r,e)},h.push=function(){var t=Array.prototype.slice.call(arguments,0),e=t.pop(),r=l(t);return h.root.child(r).push(e)},h.update=function(){var t=Array.prototype.slice.call(arguments,0),e=t.pop(),r=l(t);return h.root.child(r).update(e)},h.remove=function(){var t=Array.prototype.slice.call(arguments,0),e=l(t);return h.root.child(e).remove()},h.increment=function(){var e=Array.prototype.slice.call(arguments,0),o=l(e);return h.root.child(o).transaction(function(e){return t.isNumber(e)?e+1:null===e?1:void 0}).then(function(t){return t.committed?void 0:r.reject(new Error("Cannot increment the object at "+o))})},h.decrement=function(){var e=Array.prototype.slice.call(arguments,0),o=l(e);return h.root.child(o).transaction(function(e){return t.isNumber(e)?e-1:null===e?0:void 0}).then(function(t){return t.committed?void 0:r.reject(new Error("Cannot decrement the object at "+o))})},h.transaction=function(){var t=Array.prototype.slice.call(arguments,0),e=t.pop(),o=l(t);return h.root.child(o).transaction(function(t){return e(t)}).then(function(t){return t.committed?void 0:r.reject(new Error("Aborted"))})},h.val=function(){var t=l(Array.prototype.slice.call(arguments,0));if(t)return h.listenerSet.add(t),h.listenerSet.values.hasOwnProperty(t)?h.listenerSet.values[t]:null},h.priority=function(){var t=l(Array.prototype.slice.call(arguments,0));if(t)return h.listenerSet.add(t),h.listenerSet.priorities.hasOwnProperty(t)?h.listenerSet.priorities[t]:null},h.error=function(){var t=l(Array.prototype.slice.call(arguments,0));return t?h.listenerSet.errors[t]:null},h.children=function(){return new p(h.listenerSet)},o.$on("$destroy",function(){h.cleanup()})}t.module("flashpoint",[]),t.module("flashpoint").directive("firebase",function(){function t(t,o,i,n){var s=function(t){e&&t===r||(n.attachFirebase(t),e=!0,r=t)};i.firebase&&s(i.firebase),t.fp=n,i.$observe("firebase",s)}var e,r;return{restrict:"A",scope:!0,controller:"FirebaseCtl",priority:1e3,link:{pre:t}}}),t.module("flashpoint").directive("fpPage",["$q","$animate","Fireproof",function(e,r,o){return{restrict:"A",scope:!0,require:"^firebase",link:function(i,n,s,a){var p,l,u=function(t){r.removeClass(n,"fp-paging"),i.$paging=!1,i.$hasPrevious=l.hasPrevious&&1!==i.$pageNumber,i.$hasNext=l.hasNext,i.$keys=t.map(function(t){return t.key()}),i.$values=t.map(function(t){return t.val()}),i.$priorities=t.map(function(t){return t.getPriority()}),s.as&&(i[s.as]=i.$values),s.onPage&&i.$evalAsync(s.onPage)},c=function(t){r.removeClass(n,"fp-paging"),i.$paging=!1,r.addClass(n,"fp-error"),i.$error=t,s.onError&&i.$evalAsync(s.onError)};i.$next=function(){if(l&&!i.$paging&&i.$hasNext){var o;o=parseInt(s.limit)?parseInt(s.limit):5;var a;return a="previous"===l._direction?o+i.$values.length-1:o,r.addClass(n,"fp-paging"),i.$paging=!0,l.next(a).then(function(t){return i.$pageNumber++,a!==o&&(t=t.slice(o-1)),t}).then(u,c)}return t.isDefined(l)?e.when():e.reject(new Error("Pager does not exist. Has fp-page been set yet?"))},i.$previous=function(){if(l&&!i.$paging&&i.$hasPrevious){var o;o=parseInt(s.limit)?parseInt(s.limit):5;var a;return a="next"===l._direction?o+i.$values.length-1:o,r.addClass(n,"fp-paging"),i.$paging=!0,l.previous(a).then(function(t){return i.$pageNumber--,t=t.slice(0,o)}).then(u,c)}return t.isDefined(l)?e.when():e.reject(new Error("Pager does not exist. Has fp-page been set yet?"))},i.$reset=function(){return r.removeClass(n,"fp-paging"),r.removeClass(n,"fp-error"),delete i.$error,i.$pageNumber=0,i.$hasNext=!0,i.$hasPrevious=!1,i.$paging=!1,l=new o.Pager(new o(p)),l._direction="next",i.$next()},s.$observe("fpPage",function(t){t=t||"",0===t.length||t.match(/\/\//)||"/"===t.charAt(0)||"/"===t.charAt(t.length-1)||(p=a.root.child(t),i.$reset())})}}}]),t.module("flashpoint").factory("ChildQuery",["validatePath",function(t){function e(t){this.listenerSet=t,this._props={}}return e.prototype.startAt=function(t,e){return this._props.startAtValue=t,e&&(this._props.startAtKey=e),this},e.prototype.endAt=function(t,e){return this._props.endAtValue=t,e&&(this._props.endAtKey=e),this},e.prototype.equalTo=function(t,e){return this._props.equalToValue=t,e&&(this._props.equalToKey=e),this},e.prototype.limitToFirst=function(t){return this._props.limitToFirst=t,this},e.prototype.limitToLast=function(t){return this._props.limitToLast=t,this},e.prototype.orderByKey=function(){return this._props.orderBy="key",this},e.prototype.orderByPriority=function(){return this._props.orderBy="priority",this},e.prototype.orderByChild=function(t){return this._props.orderBy="child",this._props.orderByChild=t,this},e.prototype.of=function(){var e=Array.prototype.slice.call(arguments,0),o=t(e),i=this.listenerSet.root.child(o),n=o+".children";switch(this._props.orderBy||""){case"key":n+=".orderByKey",i=i.orderByKey();break;case"priority":n+=".orderByPriority",i=i.orderByPriority();break;case"child":n+=".orderByChild."+this._props.orderByChild,i=i.orderByChild(this._props.orderByChild)}if(this._props.startAtValue&&this._props.startAtKey?(n+=".startAtValue."+this._props.startAtValue+".startAtKey."+this._props.startAtKey,i=i.startAt(this._props.startAtValue,this._props.startAtKey)):this._props.startAtValue&&(n+=".startAtValue."+this._props.startAtValue,i=i.startAt(this._props.startAtValue)),this._props.endAtValue&&this._props.endAtKey?(n+=".endAtValue."+this._props.endAtValue+".endAtKey."+this._props.endAtKey,i=i.endAt(this._props.endAtValue,this._props.endAtKey)):this._props.endAtValue&&(n+=".endAtValue."+this._props.endAtValue,i=i.endAt(this._props.endAtValue)),this._props.equalToValue&&this._props.equalToKey?(n+=".equalToValue."+this._props.equalToValue+".equalToKey."+this._props.equalToKey,i=i.equalTo(this._props.equalToValue,this._props.equalToKey)):this._props.equalToValue&&(n+=".equalToValue."+this._props.equalToValue,i=i.equalTo(this._props.equalToValue)),this._props.limitToFirst&&(n+=".limitToFirst."+this._props.limitToFirst,i=i.limitToFirst(this._props.limitToFirst)),this._props.limitToLast&&(n+=".limitToLast."+this._props.limitToLast,i=i.limitToLast(this._props.limitToLast)),this.listenerSet.has(n))return this.listenerSet.watchers[n];var s=new r.LiveArray;return this.listenerSet.add(n,s),"child"===this._props.orderBy?s.connect(i,this._props.orderBy,this._props.orderByChild):this._props.orderBy?s.connect(i,this._props.orderBy):s.connect(i),s},e}]),t.module("flashpoint").factory("Firebase",function(){return e}).factory("ServerValue",["Firebase",function(t){return t.ServerValue}]).factory("Fireproof",["$rootScope","$q",function(t,e){return r.setNextTick(function(e){t.$evalAsync(e)}),r.bless(e),r}]),t.module("flashpoint").factory("ListenerSet",function(){function t(t,e){var r=this,o=!1;r.watchers={},r.liveWatchers={},r.values={},r.priorities={},r.errors={},r.scope=e,r.scope.$watch(function(){o||(o=!0,e.$$postDigest(function(){for(var t in r.watchers)r.watchers[t]&&!r.liveWatchers[t]&&r.remove(t)}))})}return t.prototype.add=function(t,e){var r=this;r.liveWatchers[t]=!0,r.watchers[t]||(r.watchers[t]=e?e:r.root.child(t).on("value",function(e){r.errors[t]=null,r.values[t]=e.val(),r.priorities[t]=e.getPriority(),r.scope.$evalAsync()},function(e){r.liveWatchers[t]=!1,r.watchers[t]=null,r.errors[t]=e,r.values[t]=null,r.priorities[t]=null,r.scope.$evalAsync()}))},t.prototype.has=function(t){return this.watchers.hasOwnProperty(t)},t.prototype.remove=function(t){this.watchers[t].disconnect?this.watchers[t].disconnect():this.root.child(t).off("value",this.watchers[t]),this.values[t]=null,this.errors[t]=null,this.priorities[t]=null,this.watchers[t]=null},t.prototype.clear=function(){for(var t in this.watchers)this.remove(t)},t}),t.module("flashpoint").factory("validatePath",function(){function t(t){var e=t.join("/");return 0===t.length||""===e||-1!==t.indexOf(null)||-1!==t.indexOf(void 0)?null:e}return t}),o.$inject=["$log","$q","$scope","$injector","$timeout","Firebase","Fireproof","ChildQuery","validatePath","ListenerSet"],t.module("flashpoint").controller("FirebaseCtl",o)});