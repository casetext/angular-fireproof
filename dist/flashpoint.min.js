/*! flashpoint 2.1.0, Â© 2015 J2H2 Inc. MIT License.
 * https://github.com/casetext/flashpoint
 */
!function(t,e){"function"==typeof define&&define.amd?define(["angular","firebase","fireproof"],e):"object"==typeof exports?e(require("angular"),require("firebase"),require("fireproof")):e(t.angular,t.Firebase,t.Fireproof)}(this,function(t,e,r){"use strict";function o(e,r,o,n,i,s,a){function u(t){d.listenerSet&&d.listenerSet.clear(),d.auth=t,e.$evalAsync()}function c(t){d.connected=t.val(),e.$evalAsync()}function l(t){return d.authError=null,t}function p(t){return d.authError=t,r.reject(t)}function h(){d.accountError=null}function f(t){return d.accountError=t,r.reject(t)}var d=this;d.auth=null,d.detachFirebase=function(){d.listenerSet&&(d.listenerSet.clear(),delete d.listenerSet),d.root.offAuth(u),d.root.child(".info/connected").off("value",c),delete d.connected,d.root.off(),e.$broadcast("fpDetach",d.root),delete d.root,e.$evalAsync()},d.attachFirebase=function(t){d.root&&d.detachFirebase(),d.root=new n(new o(t)),d.listenerSet=new a(d.root,e),d.root.onAuth(u),d.connected=!0,d.root.child(".info/connected").on("value",c),e.$broadcast("fpAttach",d.root)},d.goOffline=function(){o.goOffline()},d.goOnline=function(){o.goOnline()},d.unauth=function(){d.root.unauth()},d.authWithCustomToken=function(t){return d.root.authWithCustomToken(t).then(l,p)},d.authAnonymously=function(t){return d.root.authAnonymously(null,t).then(l,p)},d.authWithPassword=function(t,e){return d.root.authWithPassword({email:t,password:e}).then(l,p)},d.authWithOAuthPopup=function(t,e){return d.root.authWithOAuthPopup(t,null,e).then(l,p)},d.authWithOAuthToken=function(t,e,r){return d.root.authWithOAuthToken(t,e,null,r).then(l,p)},d.createUser=function(t,e){return d.root.createUser({email:t,password:e}).then(h,f)},d.removeUser=function(t,e){return d.root.removeUser({email:t,password:e}).then(h,f)},d.changeEmail=function(t,e,r){return d.root.changeEmail({oldEmail:t,newEmail:e,password:r}).then(h,f)},d.changePassword=function(t,e,r){return d.root.changePassword({email:t,oldPassword:e,newPassword:r}).then(h,f)},d.resetPassword=function(t){return d.root.resetPassword({email:t}).then(h,f)},d.set=function(){var t=Array.prototype.slice.call(arguments,0),e=t.pop(),r=s(t);return d.root.child(r).set(e)},d.setPriority=function(){var t=Array.prototype.slice.call(arguments,0),e=t.pop(),r=s(t);return d.root.child(r).setPriority(e)},d.setWithPriority=function(){var t=Array.prototype.slice.call(arguments,0),e=t.pop(),r=t.pop(),o=s(t);return d.root.child(o).setWithPriority(r,e)},d.push=function(){var t=Array.prototype.slice.call(arguments,0),e=t.pop(),r=s(t);return d.root.child(r).push(e)},d.update=function(){var t=Array.prototype.slice.call(arguments,0),e=t.pop(),r=s(t);return d.root.child(r).update(e)},d.remove=function(){var t=Array.prototype.slice.call(arguments,0),e=s(t);return d.root.child(e).remove()},d.increment=function(){var e=Array.prototype.slice.call(arguments,0),o=s(e);return d.root.child(o).transaction(function(e){return t.isNumber(e)?e+1:null===e?1:void 0}).then(function(t){return t.committed?void 0:r.reject(new Error("Cannot increment the object at "+o))})},d.decrement=function(){var e=Array.prototype.slice.call(arguments,0),o=s(e);return d.root.child(o).transaction(function(e){return t.isNumber(e)?e-1:null===e?0:void 0}).then(function(t){return t.committed?void 0:r.reject(new Error("Cannot decrement the object at "+o))})},d.transaction=function(){var t=Array.prototype.slice.call(arguments,0),e=t.pop(),o=s(t);return d.root.child(o).transaction(function(t){return e(t)}).then(function(t){return t.committed?void 0:r.reject(new Error("Aborted"))})},d.val=function(){var t=s(Array.prototype.slice.call(arguments,0));if(t)return d.listenerSet.add(t),d.listenerSet.values.hasOwnProperty(t)?d.listenerSet.values[t]:null},d.priority=function(){var t=s(Array.prototype.slice.call(arguments,0));if(t)return d.listenerSet.add(t),d.listenerSet.priorities.hasOwnProperty(t)?d.listenerSet.priorities[t]:null},d.error=function(){var t=s(Array.prototype.slice.call(arguments,0));return t&&d.listenerSet.errors.hasOwnProperty(t)?d.listenerSet.errors[t]:null},d.children=function(){return new i(d.listenerSet)},e.$on("$destroy",function(){d.detachFirebase()})}t.module("flashpoint",[]),t.module("flashpoint").directive("firebase",["$animate",function(t){function e(e,n,i,s){var a=function(t){r&&t===o||(s.attachFirebase(t),r=!0,o=t)};i.firebase&&a(i.firebase),e.fp=s,i.$observe("firebase",a),e.$watch("fp.connected",function(e){e===!0?t.setClass(n,"fp-connected","fp-disconnected"):e===!1?t.setClass(n,"fp-disconnected","fp-connected"):t.setClass(n,[],["fp-connected","fp-disconnected"])}),e.$watch("fp.auth",function(e){void 0===e?t.setClass(n,[],["fp-unauthenticated","fp-authenticated"]):null===e?t.setClass(n,"fp-unauthenticated","fp-authenticated"):t.setClass(n,"fp-authenticated","fp-unauthenticated")}),e.$watch("fp.authError",function(e){e?t.addClass(n,"fp-auth-error"):t.removeClass(n,"fp-auth-error")}),e.$watch("fp.accountError",function(e){e?t.addClass(n,"fp-account-error"):t.removeClass(n,"fp-account-error")})}var r,o;return{restrict:"A",scope:!0,controller:"FirebaseCtl",priority:1e3,link:{pre:e}}}]),t.module("flashpoint").directive("fpPage",["$q","$animate","Fireproof",function(e,r,o){return{restrict:"A",scope:!0,require:"^firebase",link:function(n,i,s,a){var u,c,l=function(t){r.removeClass(i,"fp-paging"),n.$paging=!1,n.$hasPrevious=c.hasPrevious&&1!==n.$pageNumber,n.$hasNext=c.hasNext,n.$keys=t.map(function(t){return t.key()}),n.$values=t.map(function(t){return t.val()}),n.$priorities=t.map(function(t){return t.getPriority()}),s.as?n[s.as]=n.$values:n[s.fpPage.split(/\//).pop()]=n.$values,s.onPage&&n.$evalAsync(s.onPage)},p=function(t){r.removeClass(i,"fp-paging"),n.$paging=!1,r.addClass(i,"fp-error"),n.$error=t,s.onError&&n.$evalAsync(s.onError)};n.$next=function(){if(c&&!n.$paging&&n.$hasNext){var o;o=parseInt(s.limit)?parseInt(s.limit):5;var a;return a="previous"===c._direction?o+n.$values.length-1:o,r.addClass(i,"fp-paging"),n.$paging=!0,c.next(a).then(function(t){return n.$pageNumber++,a!==o&&(t=t.slice(o-1)),t}).then(l,p)}return t.isDefined(c)?e.when():e.reject(new Error("Pager does not exist. Has fp-page been set yet?"))},n.$previous=function(){if(c&&!n.$paging&&n.$hasPrevious){var o;o=parseInt(s.limit)?parseInt(s.limit):5;var a;return a="next"===c._direction?o+n.$values.length-1:o,r.addClass(i,"fp-paging"),n.$paging=!0,c.previous(a).then(function(t){return n.$pageNumber--,t=t.slice(0,o)}).then(l,p)}return t.isDefined(c)?e.when():e.reject(new Error("Pager does not exist. Has fp-page been set yet?"))},n.$reset=function(){return r.removeClass(i,"fp-paging"),r.removeClass(i,"fp-error"),delete n.$error,n.$pageNumber=0,n.$hasNext=!0,n.$hasPrevious=!1,n.$paging=!1,c=new o.Pager(new o(u)),c._direction="next",n.$next()},s.$observe("fpPage",function(t){t=t||"",0===t.length||t.match(/\/\//)||"/"===t.charAt(0)||"/"===t.charAt(t.length-1)||(u=a.root.child(t),n.$reset())})}}}]),t.module("flashpoint").directive("onAuth",function(){function t(t,e,r,o){function n(e){r.onAuth&&t.$eval(r.onAuth,{$auth:e})}o.root&&o.root.onAuth(n),t.$on("fpAttach",function(t){t.onAuth(n)}),t.$on("fpDetach",function(t){t.offAuth(n)})}return{priority:750,require:"^firebase",link:{pre:t}}}),t.module("flashpoint").directive("onDisconnect",["$q","$log","validatePath",function(t,e,r){return{require:"^firebase",link:function(o,n,i,s){var a={},u=function(t){e.debug('onDisconnect: error evaluating "'+i.onDisconnect+'": '+t.code),i.onDisconnectError&&o.$eval(i.onDisconnectError,{$error:t})},c=function(e){return{$set:function(){var o=Array.prototype.slice.call(arguments,0),n=o.pop(),i=r(o);return i?(a[i]=!0,e.child(i).onDisconnect().set(n).catch(u)):t.reject(new Error("Invalid path"))},$update:function(){var o=Array.prototype.slice.call(arguments,0),n=o.pop(),i=r(o);return i?(a[i]=!0,e.child(i).onDisconnect().update(n).catch(u)):t.reject(new Error("Invalid path"))},$setWithPriority:function(){var o=Array.prototype.slice.call(arguments,0),n=o.pop(),i=o.pop(),s=r(o);return s?(a[s]=!0,e.child(s).onDisconnect().setWithPriority(i,n).catch(u)):t.reject(new Error("Invalid path"))},$remove:function(){var o=Array.prototype.slice.call(arguments,0),n=r(o);return n?(a[n]=!0,e.child(n).onDisconnect().remove().catch(u)):t.reject(new Error("Invalid path"))}}};s.root&&o.$eval(i.onDisconnect,c(s.root)),o.$on("fpAttach",function(t,e){o.$eval(i.onDisconnect,c(e))}),o.$on("fpDetach",function(t,e){for(var r in a)e.child(r).onDisconnect().cancel();a={}})}}}]),t.module("flashpoint").factory("ChildQuery",["validatePath",function(t){function e(t){this.listenerSet=t,this._props={}}return e.prototype.startAt=function(t,e){return this._props.startAtValue=t,e&&(this._props.startAtKey=e),this},e.prototype.endAt=function(t,e){return this._props.endAtValue=t,e&&(this._props.endAtKey=e),this},e.prototype.equalTo=function(t,e){return this._props.equalToValue=t,e&&(this._props.equalToKey=e),this},e.prototype.limitToFirst=function(t){return this._props.limitToFirst=t,this},e.prototype.limitToLast=function(t){return this._props.limitToLast=t,this},e.prototype.orderByKey=function(){return this._props.orderBy="key",this},e.prototype.orderByPriority=function(){return this._props.orderBy="priority",this},e.prototype.orderByChild=function(t){return this._props.orderBy="child",this._props.orderByChild=t,this},e.prototype.of=function(){var e=Array.prototype.slice.call(arguments,0),o=t(e),n=this.listenerSet.root.child(o),i=o+".children";switch(this._props.orderBy||""){case"key":i+=".orderByKey",n=n.orderByKey();break;case"priority":i+=".orderByPriority",n=n.orderByPriority();break;case"child":i+=".orderByChild."+this._props.orderByChild,n=n.orderByChild(this._props.orderByChild)}if(this._props.startAtValue&&this._props.startAtKey?(i+=".startAtValue."+this._props.startAtValue+".startAtKey."+this._props.startAtKey,n=n.startAt(this._props.startAtValue,this._props.startAtKey)):this._props.startAtValue&&(i+=".startAtValue."+this._props.startAtValue,n=n.startAt(this._props.startAtValue)),this._props.endAtValue&&this._props.endAtKey?(i+=".endAtValue."+this._props.endAtValue+".endAtKey."+this._props.endAtKey,n=n.endAt(this._props.endAtValue,this._props.endAtKey)):this._props.endAtValue&&(i+=".endAtValue."+this._props.endAtValue,n=n.endAt(this._props.endAtValue)),this._props.equalToValue&&this._props.equalToKey?(i+=".equalToValue."+this._props.equalToValue+".equalToKey."+this._props.equalToKey,n=n.equalTo(this._props.equalToValue,this._props.equalToKey)):this._props.equalToValue&&(i+=".equalToValue."+this._props.equalToValue,n=n.equalTo(this._props.equalToValue)),this._props.limitToFirst&&(i+=".limitToFirst."+this._props.limitToFirst,n=n.limitToFirst(this._props.limitToFirst)),this._props.limitToLast&&(i+=".limitToLast."+this._props.limitToLast,n=n.limitToLast(this._props.limitToLast)),this.listenerSet.has(i))return this.listenerSet.watchers[i];var s=new r.LiveArray;return this.listenerSet.add(i,s),"child"===this._props.orderBy?s.connect(n,this._props.orderBy,this._props.orderByChild):this._props.orderBy?s.connect(n,this._props.orderBy):s.connect(n),s},e}]),t.module("flashpoint").factory("Firebase",function(){return e}).factory("ServerValue",["Firebase",function(t){return t.ServerValue}]).factory("Fireproof",["$rootScope","$q",function(t,e){return r.setNextTick(function(e){t.$evalAsync(e)}),r.bless(e),r}]),t.module("flashpoint").factory("ListenerSet",function(){function t(t,e){function r(){for(var t in o.watchers)o.watchers[t]&&!o.liveWatchers[t]&&o.remove(t);o.liveWatchers={},n=!1}var o=this,n=!1;o.watchers={},o.liveWatchers={},o.values={},o.priorities={},o.errors={},o.root=t,o.scope=e,o.scope.$watch(function(){n||(n=!0,e.$$postDigest(r))})}return t.prototype.add=function(t,e){var r=this;r.liveWatchers[t]=!0,r.watchers[t]||(r.watchers[t]=e?e:r.root.child(t).on("value",function(e){r.errors[t]=null,r.values[t]=e.val(),r.priorities[t]=e.getPriority(),r.scope.$evalAsync()},function(e){r.liveWatchers[t]=!1,r.watchers[t]=null,r.errors[t]=e,r.values[t]=null,r.priorities[t]=null,r.scope.$evalAsync()}))},t.prototype.has=function(t){return this.watchers.hasOwnProperty(t)},t.prototype.remove=function(t){this.watchers[t].disconnect?this.watchers[t].disconnect():this.root.child(t).off("value",this.watchers[t]),this.values[t]=null,this.errors[t]=null,this.priorities[t]=null,this.watchers[t]=null},t.prototype.clear=function(){for(var t in this.watchers)this.remove(t)},t}),t.module("flashpoint").factory("validatePath",function(){function t(t){var e=t.join("/");return 0===t.length||""===e||-1!==t.indexOf(null)||-1!==t.indexOf(void 0)?null:e}return t}),o.$inject=["$scope","$q","Firebase","Fireproof","ChildQuery","validatePath","ListenerSet"],t.module("flashpoint").controller("FirebaseCtl",o)});